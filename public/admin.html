<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin | LM3DPTFY Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="admin-body">
  <header class="site-header admin-header">
    <div class="admin-logo-wrapper">
      <!-- Just a centered logo, NOT clickable -->
      <img src="lm3dptfy-logo-tp-cropped.png" alt="LM3DPTFY Logo" class="main-logo" />
    </div>
    <div class="admin-actions">
      <button id="btn-reload-sheets" class="pill-button">Refresh from Sheets</button>
      <button id="btn-sync-sheets" class="pill-button">Sync to Sheets</button>
      <button id="btn-export-csv" class="pill-button">Export CSV</button>
      <button id="btn-export-json" class="pill-button">Export JSON</button>
      <button id="btn-logout" class="link-button">Log out</button>
    </div>
  </header>

  <main class="page-main">
    <section class="page-section admin-section">
      <h1>Quote requests</h1>
      <p class="section-subtitle">
        Active and archived requests from lm3dptfy.online.
      </p>

      <div id="error-banner" class="error-banner" style="display:none;"></div>
      <div id="info-banner" class="info-banner" style="display:none;"></div>

      <div class="requests-wrapper">
        <h2>Active</h2>
        <table class="requests-table" id="active-table">
          <thead>
            <tr>
              <th>Created</th>
              <th>Name</th>
              <th>Email</th>
              <th>STL link</th>
              <th>Notes</th>
              <th>Status</th>
              <th>Fulfilled By</th>
              <th>Reply</th>
              <th>Archive</th>
            </tr>
          </thead>
          <tbody id="active-tbody">
            <tr>
              <td colspan="9" class="empty-row">Loading…</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="requests-wrapper archived-wrapper">
        <h2>Archived</h2>
        <table class="requests-table" id="archived-table">
          <thead>
            <tr>
              <th>Created</th>
              <th>Name</th>
              <th>Email</th>
              <th>STL link</th>
              <th>Notes</th>
              <th>Status</th>
              <th>Fulfilled By</th>
              <th>Reply</th>
              <th>Archive</th>
            </tr>
          </thead>
          <tbody id="archived-tbody">
            <tr>
              <td colspan="9" class="empty-row">Loading…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Simple login overlay -->
  <div id="login-overlay" class="login-overlay" style="display:none;">
    <div class="login-card">
      <h2>Admin login</h2>
      <p>Enter your admin email and password to view requests.</p>
      <form id="login-form">
        <label>Email<br />
          <input type="email" id="login-email" required />
        </label>
        <label>Password<br />
          <input type="password" id="login-password" required />
        </label>
        <button type="submit" class="pill-button">Log in</button>
        <div id="login-error" class="error-text" style="display:none;"></div>
      </form>
    </div>
  </div>

  <script>
    const errorBanner = document.getElementById('error-banner');
    const infoBanner = document.getElementById('info-banner');
    const loginOverlay = document.getElementById('login-overlay');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');

    function showError(msg) {
      errorBanner.textContent = msg;
      errorBanner.style.display = 'block';
      setTimeout(() => (errorBanner.style.display = 'none'), 8000);
    }

    function showInfo(msg) {
      infoBanner.textContent = msg;
      infoBanner.style.display = 'block';
      setTimeout(() => (infoBanner.style.display = 'none'), 5000);
    }

    function formatDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString();
    }

    function buildRow(request) {
      const tr = document.createElement('tr');

      const createdTd = document.createElement('td');
      createdTd.textContent = formatDate(request.createdAt);

      const nameTd = document.createElement('td');
      nameTd.textContent = request.name || '';

      const emailTd = document.createElement('td');
      if (request.email) {
        const a = document.createElement('a');
        a.href = 'mailto:' + request.email;
        a.textContent = request.email;
        emailTd.appendChild(a);
      }

      const stlTd = document.createElement('td');
      if (request.stlLink) {
        const a = document.createElement('a');
        a.href = request.stlLink;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'View STL';
        stlTd.appendChild(a);
      }

      const notesTd = document.createElement('td');
      notesTd.textContent = request.details || '';

      const statusTd = document.createElement('td');
      const statusSelect = document.createElement('select');
      ['new','responded','quote_approved','printing','completed','shipped','cancelled'].forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s.charAt(0).toUpperCase() + s.slice(1).replace('_',' ');
        if (request.status === s) opt.selected = true;
        statusSelect.appendChild(opt);
      });
      statusSelect.addEventListener('change', () => {
        updateStatus(request.id, statusSelect.value);
      });
      statusTd.appendChild(statusSelect);

      const fulfilledTd = document.createElement('td');
      const fulfilledInput = document.createElement('input');
      fulfilledInput.type = 'text';
      fulfilledInput.value = request.fulfilledBy || '';
      fulfilledInput.placeholder = 'Name';
      fulfilledInput.addEventListener('blur', () => {
        if (fulfilledInput.value !== request.fulfilledBy) {
          updateFulfilled(request.id, fulfilledInput.value);
        }
      });
      fulfilledTd.appendChild(fulfilledInput);

      const replyTd = document.createElement('td');
      const replyBtn = document.createElement('button');
      replyBtn.textContent = 'Reply';
      replyBtn.className = 'link-button';
      replyBtn.addEventListener('click', () => {
        if (request.email) {
          window.location.href =
            'mailto:' + encodeURIComponent(request.email) +
            '?subject=' + encodeURIComponent('LM3DPTFY Quote Reply') +
            '&body=' + encodeURIComponent(
              'Hi ' + (request.name || '') + ',\n\n' +
              'Thanks for your quote request for:\n' +
              (request.stlLink || '') + '\n\n' +
              '— LM3DPTFY'
            );
        }
      });
      replyTd.appendChild(replyBtn);

      const archiveTd = document.createElement('td');
      const archiveCheckbox = document.createElement('input');
      archiveCheckbox.type = 'checkbox';
      archiveCheckbox.checked = !!request.archived;
      archiveCheckbox.addEventListener('change', () => {
        updateArchive(request.id, archiveCheckbox.checked);
      });
      archiveTd.appendChild(archiveCheckbox);

      tr.appendChild(createdTd);
      tr.appendChild(nameTd);
      tr.appendChild(emailTd);
      tr.appendChild(stlTd);
      tr.appendChild(notesTd);
      tr.appendChild(statusTd);
      tr.appendChild(fulfilledTd);
      tr.appendChild(replyTd);
      tr.appendChild(archiveTd);

      return tr;
    }

    function renderTables(requests) {
      const activeTbody = document.getElementById('active-tbody');
      const archivedTbody = document.getElementById('archived-tbody');
      activeTbody.innerHTML = '';
      archivedTbody.innerHTML = '';

      const active = requests.filter(r => !r.archived);
      const archived = requests.filter(r => r.archived);

      if (active.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 9;
        td.className = 'empty-row';
        td.textContent = 'No active requests.';
        tr.appendChild(td);
        activeTbody.appendChild(tr);
      } else {
        active.forEach(r => activeTbody.appendChild(buildRow(r)));
      }

      if (archived.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 9;
        td.className = 'empty-row';
        td.textContent = 'No archived requests.';
        tr.appendChild(td);
        archivedTbody.appendChild(tr);
      } else {
        archived.forEach(r => archivedTbody.appendChild(buildRow(r)));
      }
    }

    async function fetchRequests() {
      try {
        const res = await fetch('/api/requests');
        if (!res.ok) throw new Error('Failed to load requests');
        const data = await res.json();
        renderTables(data);
      } catch (err) {
        console.error(err);
        showError('Error loading requests: ' + err.message);
      }
    }

    async function updateStatus(id, status) {
      try {
        const res = await fetch('/api/requests/' + encodeURIComponent(id) + '/status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
        });
        if (!res.ok) throw new Error('Failed to update status');
        showInfo('Status updated.');
      } catch (err) {
        console.error(err);
        showError('Error updating status: ' + err.message);
        fetchRequests();
      }
    }

    async function updateFulfilled(id, fulfilledBy) {
      try {
        const res = await fetch('/api/requests/' + encodeURIComponent(id) + '/fulfilled', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fulfilledBy }),
        });
        if (!res.ok) throw new Error('Failed to update fulfilled by');
        showInfo('Fulfilled by updated.');
      } catch (err) {
        console.error(err);
        showError('Error updating fulfilled by: ' + err.message);
        fetchRequests();
      }
    }

    async function updateArchive(id, archived) {
      try {
        const res = await fetch('/api/requests/' + encodeURIComponent(id) + '/archive', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ archived }),
        });
        if (!res.ok) throw new Error('Failed to update archive state');
        showInfo('Archive state updated.');
        fetchRequests();
      } catch (err) {
        console.error(err);
        showError('Error updating archive state: ' + err.message);
        fetchRequests();
      }
    }

    async function reloadFromSheets() {
      try {
        const res = await fetch('/api/sheets/reload', { method: 'POST' });
        if (!res.ok) throw new Error('Failed to reload from Sheets');
        const data = await res.json();
        showInfo('Reloaded ' + data.count + ' requests from Sheets.');
        fetchRequests();
      } catch (err) {
        console.error(err);
        showError('Error reloading from Sheets: ' + err.message);
      }
    }

    async function syncToSheets() {
      try {
        const res = await fetch('/api/sheets/sync', { method: 'POST' });
        if (!res.ok) throw new Error('Failed to sync to Sheets');
        const data = await res.json();
        showInfo('Synced ' + data.count + ' requests to Sheets.');
      } catch (err) {
        console.error(err);
        showError('Error syncing to Sheets: ' + err.message);
      }
    }

    async function checkAuthAndInit() {
      try {
        const res = await fetch('/api/me');
        const data = await res.json();
        if (data && data.admin) {
          loginOverlay.style.display = 'none';
          fetchRequests();
        } else {
          loginOverlay.style.display = 'flex';
        }
      } catch (err) {
        console.error(err);
        loginOverlay.style.display = 'flex';
      }
    }

    // Event handlers
    document.getElementById('btn-logout').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST' });
      loginOverlay.style.display = 'flex';
    });

    document.getElementById('btn-export-csv').addEventListener('click', () => {
      window.location.href = '/api/export/csv';
    });

    document.getElementById('btn-export-json').addEventListener('click', () => {
      window.location.href = '/api/export/json';
    });

    document.getElementById('btn-reload-sheets').addEventListener('click', () => {
      reloadFromSheets();
    });

    document.getElementById('btn-sync-sheets').addEventListener('click', () => {
      syncToSheets();
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.style.display = 'none';
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        if (!res.ok) throw new Error('Invalid credentials');
        loginOverlay.style.display = 'none';
        fetchRequests();
      } catch (err) {
        console.error(err);
        loginError.textContent = err.message;
        loginError.style.display = 'block';
      }
    });

    // Init
    checkAuthAndInit();
  </script>
</body>
</html>
