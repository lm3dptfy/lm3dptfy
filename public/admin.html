<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin | LM3DPTFY Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="page-bg">
  <header class="top-bar">
    <div class="top-bar-inner">
      <a href="index.html" class="brand-link">
        <div class="brand">
          LM3DPTFY<span class="brand-dot">.ONLINE</span>
        </div>
      </a>
      <div class="top-links">
        <button id="logoutBtn" class="link-btn" style="display:none;">Log out</button>
      </div>
    </div>
  </header>

  <main class="center-wrapper narrow">
    <!-- Login card -->
    <div id="loginCard" class="center-card">
      <div class="logo-wrap">
        <img
          src="logo-lm3dptfy-tp.png"
          alt="LM3DPTFY.online - Let Me 3D Print That For You"
          class="main-logo"
        />
      </div>

      <h1 class="hero-title small-title">Admin login</h1>
      <p class="hero-subtitle">This area is just for you to manage requests.</p>

      <form id="loginForm" class="stl-form">
        <div class="field-group">
          <label for="adminEmail" class="field-label">Admin email</label>
          <input type="email" id="adminEmail" class="field-input" required />
        </div>
        <div class="field-group">
          <label for="adminPassword" class="field-label">Password</label>
          <input type="password" id="adminPassword" class="field-input" required />
        </div>
        <button type="submit" class="btn-primary big-btn">Log in</button>
        <p id="loginStatus" class="status-message"></p>
      </form>
    </div>

    <!-- Dashboard card -->
    <div id="dashboardCard" class="center-card" style="display:none;">
      <div class="logo-wrap">
        <img
          src="logo-lm3dptfy-tp.png"
          alt="LM3DPTFY.online - Let Me 3D Print That For You"
          class="main-logo"
        />
      </div>

      <h1 class="hero-title small-title">Quote requests</h1>
      <p class="hero-subtitle">New requests from lm3dptfy.online</p>

      <div id="requestsContainer" class="table-wrapper">
        <table class="request-table">
          <thead>
            <tr>
              <th>Created</th>
              <th>Name</th>
              <th>Email</th>
              <th>STL link</th>
              <th>Status</th>
              <th>Reply</th>
            </tr>
          </thead>
          <tbody id="requestsBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>

      <p id="dashboardStatus" class="status-message"></p>
    </div>
  </main>

  <script>
    const loginForm = document.getElementById('loginForm');
    const loginStatus = document.getElementById('loginStatus');
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const requestsBody = document.getElementById('requestsBody');
    const dashboardStatus = document.getElementById('dashboardStatus');
    const logoutBtn = document.getElementById('logoutBtn');

    const STATUS_OPTIONS = [
      { value: 'new', label: 'New' },
      { value: 'responded', label: 'Responded' },
      { value: 'quote_approved', label: 'Quote approved' },
      { value: 'sent_to_printer', label: 'Sent to printer' },
      { value: 'print_complete', label: 'Print complete' },
      { value: 'qc_complete', label: 'QC complete' },
      { value: 'shipped', label: 'Shipped' },
      { value: 'paid', label: 'Paid' },
    ];

    async function loadRequests() {
      dashboardStatus.textContent = 'Loading requests...';
      try {
        const res = await fetch('/api/requests');
        if (res.status === 401) {
          loginCard.style.display = 'block';
          dashboardCard.style.display = 'none';
          logoutBtn.style.display = 'none';
          return;
        }
        const data = await res.json();
        requestsBody.innerHTML = '';
        if (data.length === 0) {
          requestsBody.innerHTML = '<tr><td colspan="6">No requests yet.</td></tr>';
        } else {
          for (const r of data) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${new Date(r.createdAt).toLocaleString()}</td>
              <td>${r.name || ''}</td>
              <td><a href="mailto:${r.email}">${r.email}</a></td>
              <td><a href="${r.stlLink}" target="_blank">View STL</a></td>
              <td class="status-cell"></td>
              <td>
                <button
                  class="link-btn reply-gmail-btn"
                  data-id="${r.id}"
                  data-email="${r.email}"
                  data-name="${r.name || ''}"
                  data-link="${r.stlLink}"
                >
                  Reply in Gmail
                </button>
              </td>
            `;
            const statusCell = tr.querySelector('.status-cell');
            const select = document.createElement('select');
            select.className = 'status-select';
            select.dataset.id = r.id;
            STATUS_OPTIONS.forEach(opt => {
              const option = document.createElement('option');
              option.value = opt.value;
              option.textContent = opt.label;
              if ((r.status || 'new') === opt.value) {
                option.selected = true;
              }
              select.appendChild(option);
            });
            statusCell.appendChild(select);

            requestsBody.appendChild(tr);
          }
        }
        dashboardStatus.textContent = '';
      } catch (err) {
        dashboardStatus.textContent = 'Error loading requests.';
      }
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginStatus.textContent = 'Logging in...';
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (!res.ok) {
          loginStatus.textContent = 'Invalid credentials.';
          return;
        }

        loginStatus.textContent = '';
        loginCard.style.display = 'none';
        dashboardCard.style.display = 'block';
        logoutBtn.style.display = 'inline-block';
        loadRequests();
      } catch (err) {
        loginStatus.textContent = 'Login error, try again.';
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST' });
      loginCard.style.display = 'block';
      dashboardCard.style.display = 'none';
      logoutBtn.style.display = 'none';
    });

    // Reply in Gmail
    requestsBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('.reply-gmail-btn');
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      const email = btn.getAttribute('data-email');
      const name = btn.getAttribute('data-name') || '';
      const link = btn.getAttribute('data-link') || '';

      const subject = '3D printing quote from LM3DPTFY';
      const bodyLines = [
        name ? `Hi ${name},` : 'Hi,',
        '',
        'Here is your 3D printing quote:',
        '',
        link ? `STLFlix link: ${link}` : '',
        '',
        'Reply here with any questions or to approve the quote.',
        '',
        'Thank you,',
        'LM3DPTFY'
      ].filter(Boolean);

      const gmailUrl =
        'https://mail.google.com/mail/?view=cm&fs=1' +
        '&to=' + encodeURIComponent(email) +
        '&su=' + encodeURIComponent(subject) +
        '&body=' + encodeURIComponent(bodyLines.join('\\n'));

      window.open(gmailUrl, '_blank');

      dashboardStatus.textContent = 'Opening Gmailâ€¦';
      dashboardStatus.classList.remove('status-success', 'status-error');

      try {
        const res = await fetch(`/api/requests/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'responded' })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          throw new Error(data.error || 'fail');
        }
        dashboardStatus.textContent = 'Status set to "Responded".';
        dashboardStatus.classList.add('status-success');
        loadRequests();
      } catch (err) {
        dashboardStatus.textContent = 'Error updating status after reply.';
        dashboardStatus.classList.add('status-error');
      }
    });

    // Status change
    requestsBody.addEventListener('change', async (e) => {
      const select = e.target.closest('.status-select');
      if (!select) return;
      const id = select.dataset.id;
      const status = select.value;

      dashboardStatus.textContent = 'Updating status...';
      dashboardStatus.classList.remove('status-success', 'status-error');

      try {
        const res = await fetch(`/api/requests/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          throw new Error(data.error || 'fail');
        }
        dashboardStatus.textContent = 'Status updated.';
        dashboardStatus.classList.add('status-success');
      } catch (err) {
        dashboardStatus.textContent = 'Error updating status.';
        dashboardStatus.classList.add('status-error');
      }
    });

    loadRequests();
  </script>
</body>
</html>
