<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin | LM3DPTFY Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />

  <!-- Modal styling kept here so you don't have to touch style.css -->
  <style>
    .modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal{
      width: min(720px, 100%);
      max-height: 86vh;
      overflow: auto;
      padding: 16px;
      border-radius: 18px;
    }
    .modal-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .modal-head h3{
      margin:0;
      font-size: 1.1rem;
      letter-spacing: -.01em;
    }
    .modal-sub{
      margin: 0 0 12px;
      color: var(--muted);
      font-size: .92rem;
      line-height: 1.35;
    }
    .fulfiller-list{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin: 12px 0;
    }
    .fulfiller-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
    }
    .btn-ghost{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.75);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 700;
      cursor:pointer;
    }
    .btn-danger{
      border: 1px solid rgba(225,29,72,.35);
      background: rgba(225,29,72,.08);
      color: #9f1239;
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
      white-space: nowrap;
    }
    .modal-actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      border-top: 1px solid rgba(15,23,42,.08);
      padding-top: 12px;
      margin-top: 10px;
    }
    .modal-actions .left{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: .92rem;
    }
    .modal-actions .right{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .inline-note{
      color: var(--muted);
      font-size: .85rem;
      margin: 0;
    }
  </style>
</head>

<body class="admin-page">
  <div class="page-shell">
    <!-- Top bar -->
    <header class="topbar">
      <div class="topbar-inner">
        <a class="brand" href="/" title="Home">
          <img src="/lm3dptfy-logo-tp-cropped.png" alt="LM3DPTFY logo" />
          <div class="brand-title">
            <strong>Let Me 3D Print That For You</strong>
            <span>Admin dashboard • Private</span>
          </div>
        </a>

        <div class="nav-right">
          <a class="btn-primary btn-sm" href="/">Home</a>
          <button id="logoutTopBtn" class="btn-primary btn-sm" type="button">Log out</button>
        </div>
      </div>
    </header>

    <main class="page-main">
      <div class="main-inner">

        <!-- Login section -->
        <div id="loginCard" class="card" style="max-width:560px;margin:0 auto;padding:18px;">
          <h1 class="admin-title" style="font-size:1.25rem;margin:0 0 6px;">Admin login</h1>
          <p class="admin-subtitle" style="margin:0 0 14px;">Sign in to see and manage quote requests.</p>

          <form id="loginForm" class="stl-form">
            <div>
              <label for="adminEmail" class="field-label">Admin email</label>
              <input type="email" id="adminEmail" class="field-input" required />
            </div>
            <div>
              <label for="adminPassword" class="field-label">Password</label>
              <input type="password" id="adminPassword" class="field-input" required />
            </div>
            <button type="submit" class="btn-primary btn-block">Log in</button>
            <p id="loginStatus" class="status-message" style="display:none;"></p>
          </form>
        </div>

        <!-- Dashboard section -->
        <div id="dashboardCard" style="display:none;">
          <div class="admin-head">
            <div>
              <h1 class="admin-title">Quote requests</h1>
              <p class="admin-subtitle">Active + archived requests from lm3dptfy.online.</p>
            </div>

            <div class="admin-actions">
              <button id="reloadSheetsBtn" class="btn-primary btn-sm" type="button">Refresh from Sheets</button>
              <button id="syncSheetsBtn" class="btn-primary btn-sm" type="button">Sync to Sheets</button>
              <button id="manageFulfillersBtn" class="btn-primary btn-sm" type="button">Manage Fulfilled By</button>
              <a href="/api/export/csv" class="btn-primary btn-sm" style="text-decoration:none;">Export CSV</a>
              <a href="/api/export/json" class="btn-primary btn-sm" style="text-decoration:none;">Export JSON</a>
            </div>
          </div>

          <p id="dashboardStatus" class="status-message" style="display:none;"></p>

          <section class="card table-card">
            <div class="section-header">
              <h2 class="section-title" style="margin:0;">Active</h2>
              <p class="tip" style="margin:6px 0 0;">
                Tip: Set status to <strong>Shipped</strong> to enable Tracking #. When you paste tracking, an email draft opens automatically.
              </p>
            </div>

            <div id="activeList" class="request-list"></div>
            <div id="activeEmpty" class="empty-state" style="display:none;">No active requests.</div>
          </section>

          <section class="card table-card">
            <div class="section-header">
              <h2 class="section-title" style="margin:0;">Archived</h2>
              <p class="tip" style="margin:6px 0 0;">Archived requests stay editable. Uncheck Archive to move back to Active.</p>
            </div>

            <div id="archivedList" class="request-list"></div>
            <div id="archivedEmpty" class="empty-state" style="display:none;">No archived requests.</div>
          </section>
        </div>

      </div>
    </main>

    <footer class="site-footer">
      Admin panel • LM3DPTFY.online
    </footer>
  </div>

  <!-- Fulfilled-by manager modal -->
  <div id="fulfillerModal" class="modal-overlay" aria-hidden="true">
    <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="fulfillerModalTitle">
      <div class="modal-head">
        <div>
          <h3 id="fulfillerModalTitle">Manage “Fulfilled by” names</h3>
          <p class="modal-sub">
            Add, rename, or remove names shown in the <strong>Fulfilled by</strong> dropdown.
            Saved in this browser (localStorage).
          </p>
        </div>
        <button id="closeFulfillerModalBtn" class="btn-ghost" type="button">Close</button>
      </div>

      <p class="inline-note">
        Tip: You can remove names from the list; existing orders using that name will still display it for that order.
      </p>

      <div id="fulfillerList" class="fulfiller-list"></div>

      <div class="fulfiller-row" style="margin-top:10px;">
        <input id="newFulfillerInput" class="field-input" type="text" placeholder="Add a new name (e.g., Scarlet)" />
        <button id="addFulfillerBtn" class="btn-primary btn-sm" type="button">Add</button>
      </div>

      <div class="modal-actions">
        <div class="left">
          <label style="display:flex;align-items:center;gap:10px;">
            <input id="autoImportToggle" type="checkbox" />
            Auto-add names seen in orders
          </label>
        </div>
        <div class="right">
          <button id="resetFulfillersBtn" class="btn-ghost" type="button">Reset defaults</button>
          <button id="saveFulfillersBtn" class="btn-primary btn-sm" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const loginForm = document.getElementById('loginForm');
    const loginStatus = document.getElementById('loginStatus');
    const dashboardStatus = document.getElementById('dashboardStatus');

    const activeList = document.getElementById('activeList');
    const archivedList = document.getElementById('archivedList');
    const activeEmpty = document.getElementById('activeEmpty');
    const archivedEmpty = document.getElementById('archivedEmpty');

    const reloadBtn = document.getElementById('reloadSheetsBtn');
    const syncBtn = document.getElementById('syncSheetsBtn');
    const logoutTopBtn = document.getElementById('logoutTopBtn');

    const manageFulfillersBtn = document.getElementById('manageFulfillersBtn');
    const fulfillerModal = document.getElementById('fulfillerModal');
    const closeFulfillerModalBtn = document.getElementById('closeFulfillerModalBtn');
    const fulfillerListEl = document.getElementById('fulfillerList');
    const newFulfillerInput = document.getElementById('newFulfillerInput');
    const addFulfillerBtn = document.getElementById('addFulfillerBtn');
    const resetFulfillersBtn = document.getElementById('resetFulfillersBtn');
    const saveFulfillersBtn = document.getElementById('saveFulfillersBtn');
    const autoImportToggle = document.getElementById('autoImportToggle');

    const STATUS_OPTIONS = [
      { value: 'new', label: 'New' },
      { value: 'responded', label: 'Responded' },
      { value: 'quote_approved', label: 'Quote approved' },
      { value: 'sent_to_printer', label: 'Sent to printer' },
      { value: 'print_complete', label: 'Print complete' },
      { value: 'qc_complete', label: 'QC complete' },
      { value: 'shipped', label: 'Shipped' },
      { value: 'paid', label: 'Paid' },
    ];

    // Gmail account hint so it opens the right inbox
    const GMAIL_AUTH_USER = 'lm3dptfy@gmail.com';

    // Defaults you wanted
    const DEFAULT_FULFILLERS = ['Robert', 'Jared', 'Terence'];

    // localStorage key
    const FULFILLER_STORAGE_KEY = 'lm3dptfy_fulfillers_v1';

    // In-memory state
    let fulfillerState = {
      names: [...DEFAULT_FULFILLERS],
      autoImport: false
    };

    function normalizeName(name) {
      return (name || '').trim().replace(/\s+/g, ' ');
    }

    function uniqueNames(names) {
      const out = [];
      const seen = new Set();
      for (const raw of names) {
        const n = normalizeName(raw);
        if (!n) continue;
        const key = n.toLowerCase();
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(n);
      }
      return out;
    }

    function loadFulfillerState() {
      try {
        const raw = localStorage.getItem(FULFILLER_STORAGE_KEY);
        if (!raw) return;

        const parsed = JSON.parse(raw);
        const names = Array.isArray(parsed.names) ? uniqueNames(parsed.names) : null;
        const autoImport = !!parsed.autoImport;

        if (names && names.length >= 0) {
          fulfillerState.names = names.length ? names : [];
          fulfillerState.autoImport = autoImport;
        }
      } catch (e) {
        // ignore
      }
    }

    function saveFulfillerState() {
      localStorage.setItem(FULFILLER_STORAGE_KEY, JSON.stringify({
        names: fulfillerState.names,
        autoImport: fulfillerState.autoImport
      }));
    }

    function showDashStatus(msg, isError) {
      dashboardStatus.style.display = 'block';
      dashboardStatus.textContent = msg;
      dashboardStatus.classList.toggle('status-error', !!isError);
      dashboardStatus.classList.toggle('status-success', !isError);
    }

    function buildGmailUrl(to, subject, body) {
      const base = 'https://mail.google.com/mail/?view=cm&fs=1&tf=1';
      const params = new URLSearchParams();
      params.set('authuser', GMAIL_AUTH_USER);
      params.set('to', to || '');
      params.set('su', subject || '');
      params.set('body', body || '');
      return base + '&' + params.toString();
    }

    function formatDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '';
      return d.toLocaleString();
    }

    function el(tag, className, text) {
      const node = document.createElement(tag);
      if (className) node.className = className;
      if (typeof text === 'string') node.textContent = text;
      return node;
    }

    function metaItem(label, valueNode) {
      const wrap = el('div', 'meta-item');
      wrap.appendChild(el('div', 'meta-label', label));
      const v = el('div', 'meta-value');
      v.appendChild(valueNode);
      wrap.appendChild(v);
      return wrap;
    }

    function openFulfillerModal() {
      autoImportToggle.checked = !!fulfillerState.autoImport;
      renderFulfillerEditor();
      fulfillerModal.style.display = 'flex';
      fulfillerModal.setAttribute('aria-hidden', 'false');
      newFulfillerInput.value = '';
      setTimeout(() => newFulfillerInput.focus(), 0);
    }

    function closeFulfillerModal() {
      fulfillerModal.style.display = 'none';
      fulfillerModal.setAttribute('aria-hidden', 'true');
    }

    function renderFulfillerEditor() {
      fulfillerListEl.innerHTML = '';

      const names = (fulfillerState.names && fulfillerState.names.length)
        ? fulfillerState.names
        : [];

      if (!names.length) {
        const empty = el('div', 'empty-state', 'No names in the list. Add one below.');
        fulfillerListEl.appendChild(empty);
        return;
      }

      names.forEach((name, idx) => {
        const row = el('div', 'fulfiller-row');

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'field-input fulfiller-name-input';
        input.value = name;
        input.dataset.index = String(idx);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-danger';
        removeBtn.textContent = 'Remove';
        removeBtn.dataset.index = String(idx);

        row.appendChild(input);
        row.appendChild(removeBtn);
        fulfillerListEl.appendChild(row);
      });
    }

    function commitEditorToState() {
      const inputs = Array.from(document.querySelectorAll('.fulfiller-name-input'));
      const names = inputs.map(i => i.value);
      fulfillerState.names = uniqueNames(names);
      fulfillerState.autoImport = !!autoImportToggle.checked;
      saveFulfillerState();
    }

    function buildFulfilledSelect(currentValue, id) {
      const fulfilledSelect = document.createElement('select');
      fulfilledSelect.className = 'status-select fulfilled-select';
      fulfilledSelect.dataset.id = id;

      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '—';
      fulfilledSelect.appendChild(placeholder);

      // Use managed list
      const managed = Array.isArray(fulfillerState.names) ? fulfillerState.names : [];

      // Ensure current value appears even if it’s not in the list (so old orders don’t break)
      const list = [...managed];
      if (currentValue && !list.includes(currentValue)) list.unshift(currentValue);

      list.forEach(name => {
        const o = document.createElement('option');
        o.value = name;
        o.textContent = name;
        if ((currentValue || '') === name) o.selected = true;
        fulfilledSelect.appendChild(o);
      });

      return fulfilledSelect;
    }

    function renderCard(r) {
      const card = el('div', 'request-card');
      card.dataset.id = r.id;

      // Header
      const header = el('div', 'request-card-header');

      const title = el('div', 'request-title');
      const nameLine = el('div', 'request-title-main', r.name || '(no name)');
      const subLine = el('div', 'request-title-sub', `Created: ${formatDate(r.createdAt)}`);
      title.appendChild(nameLine);
      title.appendChild(subLine);

      const right = el('div', 'request-header-right');
      const replyBtn = el('a', 'btn-primary btn-sm reply-link', 'Reply');
      replyBtn.href = '#';
      replyBtn.dataset.email = r.email || '';
      replyBtn.dataset.name = r.name || '';
      replyBtn.dataset.stl = r.stlLink || '';
      right.appendChild(replyBtn);

      header.appendChild(title);
      header.appendChild(right);

      // Meta grid
      const meta = el('div', 'request-meta-grid');

      // Email
      const emailNode = (() => {
        if (!r.email) return document.createTextNode('');
        const a = document.createElement('a');
        a.href = `mailto:${r.email}`;
        a.textContent = r.email;
        return a;
      })();
      meta.appendChild(metaItem('Email', emailNode));

      // STL
      const stlNode = (() => {
        if (!r.stlLink) return document.createTextNode('');
        const a = document.createElement('a');
        a.href = r.stlLink;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'View STLFlix link';
        return a;
      })();
      meta.appendChild(metaItem('STL Link', stlNode));

      // Customer notes (full width)
      const notesWrap = el('div', 'meta-item meta-span');
      notesWrap.appendChild(el('div', 'meta-label', 'Customer notes'));
      const notesVal = el('div', 'meta-value');
      notesVal.textContent = r.details || '';
      notesWrap.appendChild(notesVal);
      meta.appendChild(notesWrap);

      // Admin notes textarea (full width)
      const adminWrap = el('div', 'meta-item meta-span');
      adminWrap.appendChild(el('div', 'meta-label', 'Admin notes'));
      const adminTa = document.createElement('textarea');
      adminTa.className = 'admin-notes-input';
      adminTa.placeholder = 'What did we email the user?';
      adminTa.value = r.adminNotes || '';
      adminTa.dataset.id = r.id;
      adminWrap.appendChild(adminTa);
      meta.appendChild(adminWrap);

      // Controls grid
      const controls = el('div', 'request-controls');

      // Status
      const statusBlock = el('div', 'control');
      statusBlock.appendChild(el('div', 'control-label', 'Status'));
      const statusSelect = document.createElement('select');
      statusSelect.className = 'status-select status-select-main';
      statusSelect.dataset.id = r.id;
      STATUS_OPTIONS.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        if ((r.status || 'new') === opt.value) o.selected = true;
        statusSelect.appendChild(o);
      });
      statusBlock.appendChild(statusSelect);

      // Fulfilled by (managed names)
      const fulfilledBlock = el('div', 'control');
      fulfilledBlock.appendChild(el('div', 'control-label', 'Fulfilled by'));
      const fulfilledSelect = buildFulfilledSelect((r.fulfilledBy || ''), r.id);
      fulfilledBlock.appendChild(fulfilledSelect);

      // Tracking
      const trackingBlock = el('div', 'control');
      trackingBlock.appendChild(el('div', 'control-label', 'Tracking #'));
      const trackingInput = document.createElement('input');
      trackingInput.type = 'text';
      trackingInput.className = 'tracking-input';
      trackingInput.dataset.id = r.id;
      trackingInput.dataset.email = r.email || '';
      trackingInput.dataset.name = r.name || '';
      trackingInput.dataset.stl = r.stlLink || '';
      trackingInput.value = r.trackingNumber || '';

      const isShipped = (r.status || '') === 'shipped';
      trackingInput.disabled = !isShipped;
      trackingInput.placeholder = isShipped ? 'Paste tracking number' : 'Set status to Shipped';
      trackingBlock.appendChild(trackingInput);

      // Archive
      const archiveBlock = el('div', 'control');
      archiveBlock.appendChild(el('div', 'control-label', 'Archive'));
      const archiveRow = el('label', 'archive-row');
      const archiveCheckbox = document.createElement('input');
      archiveCheckbox.type = 'checkbox';
      archiveCheckbox.className = 'archive-checkbox';
      archiveCheckbox.dataset.id = r.id;
      archiveCheckbox.checked = !!r.archived;

      const archiveText = el('span', 'archive-text', r.archived ? 'Archived' : 'Active');
      archiveRow.appendChild(archiveCheckbox);
      archiveRow.appendChild(archiveText);
      archiveBlock.appendChild(archiveRow);

      controls.appendChild(statusBlock);
      controls.appendChild(fulfilledBlock);
      controls.appendChild(trackingBlock);
      controls.appendChild(archiveBlock);

      // Assemble
      card.appendChild(header);
      card.appendChild(meta);
      card.appendChild(controls);

      return card;
    }

    async function loadRequests() {
      try {
        const res = await fetch('/api/requests', { credentials: 'include' });
        if (res.status === 401) {
          loginCard.style.display = 'block';
          dashboardCard.style.display = 'none';
          return;
        }

        const data = await res.json();

        // Optional auto-import from data
        if (fulfillerState.autoImport) {
          const fromData = uniqueNames(
            data.map(r => (r.fulfilledBy || '').trim()).filter(Boolean)
          );
          const merged = uniqueNames([...(fulfillerState.names || []), ...fromData]);
          if (JSON.stringify(merged) !== JSON.stringify(fulfillerState.names || [])) {
            fulfillerState.names = merged;
            saveFulfillerState();
          }
        }

        const active = data.filter(r => !r.archived);
        const archived = data.filter(r => r.archived);

        activeList.innerHTML = '';
        archivedList.innerHTML = '';

        activeEmpty.style.display = active.length ? 'none' : 'block';
        archivedEmpty.style.display = archived.length ? 'none' : 'block';

        active.forEach(r => activeList.appendChild(renderCard(r)));
        archived.forEach(r => archivedList.appendChild(renderCard(r)));

        loginCard.style.display = 'none';
        dashboardCard.style.display = 'block';
        showDashStatus('Loaded ' + data.length + ' request(s).', false);
      } catch (err) {
        console.error(err);
        showDashStatus('Error loading requests: ' + err.message, true);
      }
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginStatus.style.display = 'block';
      loginStatus.textContent = 'Signing in...';
      loginStatus.classList.remove('status-error', 'status-success');

      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        if (!res.ok) throw new Error('Invalid email or password');

        loginStatus.textContent = 'Login successful. Loading dashboard...';
        loginStatus.classList.add('status-success');

        await loadRequests();
      } catch (err) {
        loginStatus.textContent = err.message;
        loginStatus.classList.add('status-error');
      }
    });

    async function doLogout() {
      try { await fetch('/api/logout', { method: 'POST', credentials: 'include' }); } catch(e){}
      loginCard.style.display = 'block';
      dashboardCard.style.display = 'none';
      loginForm.reset();
    }

    logoutTopBtn.addEventListener('click', doLogout);

    if (reloadBtn) {
      reloadBtn.addEventListener('click', async () => {
        showDashStatus('Refreshing from Google Sheets...', false);
        try {
          const res = await fetch('/api/sheets/reload', { method: 'POST', credentials: 'include' });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || 'Reload failed');
          showDashStatus('Reloaded ' + (data.count || 0) + ' requests from Sheets.', false);
          loadRequests();
        } catch (err) {
          showDashStatus('Reload failed: ' + err.message, true);
        }
      });
    }

    if (syncBtn) {
      syncBtn.addEventListener('click', async () => {
        showDashStatus('Syncing to Google Sheets...', false);
        try {
          const res = await fetch('/api/sheets/sync', { method: 'POST', credentials: 'include' });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || 'Sync failed');
          showDashStatus('Synced ' + (data.count || 0) + ' requests to Sheets.', false);
        } catch (err) {
          showDashStatus('Sync failed: ' + err.message, true);
        }
      });
    }

    function openReplyDraft(fromEl) {
      const email = fromEl.dataset.email || '';
      if (!email) return;

      const name = fromEl.dataset.name || '';
      const stl = fromEl.dataset.stl || '';
      const subject = 'LM3DPTFY Quote Reply';
      const body =
        'Hi ' + name + ',\n\n' +
        'Thanks for your quote request for:\n' + stl + '\n\n' +
        '— LM3DPTFY';

      window.open(buildGmailUrl(email, subject, body), '_blank');
    }

    function openTrackingEmail(fromInput) {
      const email = fromInput.dataset.email || '';
      if (!email) return;

      const name = fromInput.dataset.name || '';
      const tracking = (fromInput.value || '').trim();
      const stl = fromInput.dataset.stl || '';

      const subject = 'Your LM3DPTFY order has shipped — Tracking #' + (tracking ? (' ' + tracking) : '');
      const body =
        'Hi ' + name + ',\n\n' +
        'Great news — your print has shipped!\n\n' +
        'Tracking number: ' + tracking + '\n\n' +
        (stl ? ('Your model link: ' + stl + '\n\n') : '') +
        'Thanks again!\n' +
        '— LM3DPTFY';

      window.open(buildGmailUrl(email, subject, body), '_blank');
    }

    async function updateStatus(id, status) {
      const res = await fetch(`/api/requests/${id}/status`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || 'Failed to update status');
    }

    async function updateFulfilled(id, fulfilledBy) {
      const res = await fetch(`/api/requests/${id}/fulfilled`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fulfilledBy }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || 'Failed to update fulfilled by');
    }

    async function updateArchive(id, archived) {
      const res = await fetch(`/api/requests/${id}/archive`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ archived }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || 'Failed to update archive');
    }

    async function saveAdminNotes(textarea) {
      const id = textarea.dataset.id;
      const adminNotes = textarea.value || '';
      await fetch(`/api/requests/${id}/admin-notes`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adminNotes }),
      });
    }

    async function saveTracking(input) {
      const id = input.dataset.id;
      const trackingNumber = input.value || '';
      await fetch(`/api/requests/${id}/tracking`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ trackingNumber }),
      });
    }

    function handleChange(e) {
      const t = e.target;

      if (t.classList.contains('status-select-main')) {
        const id = t.dataset.id;
        const status = t.value;
        showDashStatus('Updating status...', false);

        updateStatus(id, status)
          .then(() => loadRequests())
          .catch(err => showDashStatus('Error updating status: ' + err.message, true));
      }

      if (t.classList.contains('fulfilled-select')) {
        const id = t.dataset.id;
        const fulfilledBy = t.value;
        showDashStatus('Updating fulfilled by...', false);

        updateFulfilled(id, fulfilledBy)
          .then(() => showDashStatus('Fulfilled by updated.', false))
          .catch(err => showDashStatus('Error updating fulfilled by: ' + err.message, true));
      }

      if (t.classList.contains('archive-checkbox')) {
        const id = t.dataset.id;
        const archived = t.checked;
        showDashStatus(archived ? 'Archiving...' : 'Unarchiving...', false);

        updateArchive(id, archived)
          .then(() => loadRequests())
          .catch(err => showDashStatus('Error updating archive: ' + err.message, true));
      }
    }

    function handleClick(e) {
      const reply = e.target.closest('.reply-link');
      if (reply) {
        e.preventDefault();
        openReplyDraft(reply);
      }
    }

    function handleFocusOutCapture(e) {
      const t = e.target;
      if (t.classList.contains('admin-notes-input')) {
        saveAdminNotes(t).catch(() => {});
      }
      if (t.classList.contains('tracking-input')) {
        saveTracking(t).catch(() => {});
      }
    }

    function handlePasteCapture(e) {
      const t = e.target;
      if (!t.classList.contains('tracking-input')) return;
      if (t.disabled) return;

      setTimeout(() => {
        saveTracking(t).catch(() => {});
        if ((t.value || '').trim()) openTrackingEmail(t);
      }, 10);
    }

    // Fulfilled-by modal events
    manageFulfillersBtn.addEventListener('click', openFulfillerModal);
    closeFulfillerModalBtn.addEventListener('click', closeFulfillerModal);

    fulfillerModal.addEventListener('click', (e) => {
      if (e.target === fulfillerModal) closeFulfillerModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && fulfillerModal.style.display === 'flex') closeFulfillerModal();
    });

    addFulfillerBtn.addEventListener('click', () => {
      const name = normalizeName(newFulfillerInput.value);
      if (!name) return;

      fulfillerState.names = uniqueNames([...(fulfillerState.names || []), name]);
      newFulfillerInput.value = '';
      renderFulfillerEditor();
      newFulfillerInput.focus();
    });

    fulfillerListEl.addEventListener('click', (e) => {
      const btn = e.target.closest('button.btn-danger');
      if (!btn) return;
      const idx = Number(btn.dataset.index);
      if (!Number.isFinite(idx)) return;

      const names = [...(fulfillerState.names || [])];
      names.splice(idx, 1);
      fulfillerState.names = names;
      renderFulfillerEditor();
    });

    resetFulfillersBtn.addEventListener('click', () => {
      fulfillerState.names = [...DEFAULT_FULFILLERS];
      fulfillerState.autoImport = false;
      autoImportToggle.checked = false;
      renderFulfillerEditor();
    });

    saveFulfillersBtn.addEventListener('click', () => {
      commitEditorToState();
      closeFulfillerModal();
      loadRequests(); // refresh dropdowns immediately
      showDashStatus('Updated “Fulfilled by” names.', false);
    });

    activeList.addEventListener('change', handleChange);
    archivedList.addEventListener('change', handleChange);
    activeList.addEventListener('click', handleClick);
    archivedList.addEventListener('click', handleClick);

    document.addEventListener('focusout', handleFocusOutCapture, true);
    document.addEventListener('paste', handlePasteCapture, true);

    // Init
    loadFulfillerState();
    loadRequests();
  </script>
</body>
</html>
