<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin | Let Me 3D Print That For You</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="stylesheet" href="/style.css?v=modern2" />
</head>
<body>
  <div class="page-shell">
    <header class="header">
      <div class="header-inner">
        <a class="brand" href="/" style="text-decoration:none;">
          <img src="/lm3dptfy-logo-tp-cropped.png" alt="LM3DPTFY" />
          <div class="brand-text">
            <div class="brand-title">Let Me 3D Print That For You</div>
            <div class="brand-sub">Admin dashboard • Private</div>
          </div>
        </a>
        <nav class="nav">
          <a href="/">Home</a>
          <a href="#" id="logoutLink">Log out</a>
        </nav>
      </div>
    </header>

    <main class="page-main">
      <div class="admin-wrap">
        <!-- LOGIN -->
        <section class="card admin-card" id="loginCard">
          <div class="admin-top">
            <div>
              <h2>Admin login</h2>
              <p>Sign in to see and manage quote requests.</p>
            </div>
          </div>

          <form id="loginForm" style="max-width:520px; margin-top:12px;">
            <label class="field-label" for="adminEmail">Admin email</label>
            <input class="field-input" type="email" id="adminEmail" required />

            <div style="height:10px;"></div>

            <label class="field-label" for="adminPassword">Password</label>
            <input class="field-input" type="password" id="adminPassword" required />

            <button class="btn-primary" type="submit" style="max-width:520px;">Log in</button>
            <div id="loginStatus" class="status-message"></div>
          </form>
        </section>

        <!-- DASHBOARD -->
        <section class="card admin-card" id="dashboardCard" style="display:none;">
          <div class="admin-top">
            <div>
              <h2>Quote requests</h2>
              <p>Active and archived requests from lm3dptfy.online.</p>
            </div>
            <div class="actions">
              <button class="btn-small" id="reloadSheetsBtn" type="button">Refresh from Sheets</button>
              <button class="btn-small" id="syncSheetsBtn" type="button">Sync to Sheets</button>
              <a class="btn-small" href="/api/export/csv" style="display:inline-block;">Export CSV</a>
              <a class="btn-small" href="/api/export/json" style="display:inline-block;">Export JSON</a>
            </div>
          </div>

          <div id="dashboardStatus" class="status-message" style="margin-top:10px;"></div>

          <div style="margin-top:14px; font-weight:900;">Active</div>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>STL link</th>
                  <th>Notes</th>
                  <th>Admin Notes</th>
                  <th>Status</th>
                  <th>Fulfilled By</th>
                  <th>Tracking #</th>
                  <th>Reply</th>
                  <th>Archive</th>
                </tr>
              </thead>
              <tbody id="activeBody">
                <tr><td colspan="11" style="padding:16px;">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="small-note" style="text-align:left; margin-top:10px;">
            Tip: Set status to <b>Shipped</b> to enable Tracking #. When you paste tracking, an email draft opens automatically.
          </div>

          <div style="margin-top:18px; font-weight:900;">Archived</div>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>STL link</th>
                  <th>Notes</th>
                  <th>Admin Notes</th>
                  <th>Status</th>
                  <th>Fulfilled By</th>
                  <th>Tracking #</th>
                  <th>Reply</th>
                  <th>Archive</th>
                </tr>
              </thead>
              <tbody id="archivedBody">
                <tr><td colspan="11" style="padding:16px;">No archived requests.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="small-note" style="text-align:left; margin-top:12px;">
            Tip: Bookmark <b>/admin</b> or <b>/admin.html</b>. This page is meant to stay private.
          </div>
        </section>
      </div>
    </main>

    <footer class="footer">LM3DPTFY Admin · Keep this page private.</footer>
  </div>

  <script>
    const loginForm = document.getElementById('loginForm');
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const loginStatus = document.getElementById('loginStatus');
    const dashboardStatus = document.getElementById('dashboardStatus');
    const activeBody = document.getElementById('activeBody');
    const archivedBody = document.getElementById('archivedBody');

    const reloadBtn = document.getElementById('reloadSheetsBtn');
    const syncBtn = document.getElementById('syncSheetsBtn');
    const logoutLink = document.getElementById('logoutLink');

    const STATUS_OPTIONS = [
      { value: 'new', label: 'New' },
      { value: 'responded', label: 'Responded' },
      { value: 'quote_approved', label: 'Quote approved' },
      { value: 'sent_to_printer', label: 'Sent to printer' },
      { value: 'print_complete', label: 'Print complete' },
      { value: 'qc_complete', label: 'QC complete' },
      { value: 'shipped', label: 'Shipped' },
      { value: 'paid', label: 'Paid' },
    ];

    const FULFILLED_BY_OPTIONS = [
      { value: '', label: '-- None --' },
      { value: 'Jared', label: 'Jared' },
      { value: 'Robert', label: 'Robert' },
      { value: 'Terence', label: 'Terence' },
    ];

    const GMAIL_AUTH_USER = 'lm3dptfy@gmail.com';

    function buildGmailUrl(toEmail, subject, body) {
      let url = 'https://mail.google.com/mail/?view=cm&fs=1&tf=1';
      url += '&authuser=' + encodeURIComponent(GMAIL_AUTH_USER);
      url += '&to=' + encodeURIComponent(toEmail);
      url += '&su=' + encodeURIComponent(subject);
      url += '&body=' + encodeURIComponent(body);
      return url;
    }

    function setMsg(el, msg, ok=true){
      el.textContent = msg;
      el.style.display = 'block';
      el.classList.toggle('status-success', ok);
      el.classList.toggle('status-error', !ok);
    }

    function renderRow(r){
      const tr = document.createElement('tr');

      const tdCreated = document.createElement('td');
      tdCreated.textContent = r.createdAt ? new Date(r.createdAt).toLocaleString() : '';
      tr.appendChild(tdCreated);

      const tdName = document.createElement('td');
      tdName.textContent = r.name || '';
      tr.appendChild(tdName);

      const tdEmail = document.createElement('td');
      if (r.email){
        const a = document.createElement('a');
        a.href = 'mailto:' + r.email;
        a.textContent = r.email;
        tdEmail.appendChild(a);
      }
      tr.appendChild(tdEmail);

      const tdStl = document.createElement('td');
      if (r.stlLink){
        const a = document.createElement('a');
        a.href = r.stlLink;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'View STL';
        tdStl.appendChild(a);
      }
      tr.appendChild(tdStl);

      const tdNotes = document.createElement('td');
      tdNotes.textContent = r.details || '';
      tr.appendChild(tdNotes);

      // Admin Notes (saved to Sheets)
      const tdAdminNotes = document.createElement('td');
      const ta = document.createElement('textarea');
      ta.className = 'cell-input cell-textarea admin-notes';
      ta.placeholder = 'What did we email the user?';
      ta.dataset.id = r.id;
      ta.value = r.adminNotes || '';
      tdAdminNotes.appendChild(ta);
      tr.appendChild(tdAdminNotes);

      const tdStatus = document.createElement('td');
      const selStatus = document.createElement('select');
      selStatus.className = 'select status-select';
      selStatus.dataset.id = r.id;
      STATUS_OPTIONS.forEach(opt=>{
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        if ((r.status||'new') === opt.value) o.selected = true;
        selStatus.appendChild(o);
      });
      tdStatus.appendChild(selStatus);
      tr.appendChild(tdStatus);

      const tdFul = document.createElement('td');
      const selFul = document.createElement('select');
      selFul.className = 'select fulfilled-select';
      selFul.dataset.id = r.id;
      FULFILLED_BY_OPTIONS.forEach(opt=>{
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        if ((r.fulfilledBy||'') === opt.value) o.selected = true;
        selFul.appendChild(o);
      });
      tdFul.appendChild(selFul);
      tr.appendChild(tdFul);

      // Tracking (enabled only if shipped)
      const tdTrack = document.createElement('td');
      const track = document.createElement('input');
      track.type = 'text';
      track.className = 'cell-input tracking-input';
      track.placeholder = (r.status === 'shipped') ? 'Paste tracking' : 'Set to Shipped';
      track.disabled = (r.status !== 'shipped');
      track.dataset.id = r.id;
      track.dataset.email = r.email || '';
      track.dataset.name = r.name || '';
      track.dataset.prev = (r.trackingNumber || '');
      track.value = (r.trackingNumber || '');
      tdTrack.appendChild(track);
      tr.appendChild(tdTrack);

      const tdReply = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = 'link-btn reply-btn';
      btn.dataset.email = r.email || '';
      btn.dataset.name = r.name || '';
      btn.dataset.stl = r.stlLink || '';
      btn.textContent = 'Reply';
      tdReply.appendChild(btn);
      tr.appendChild(tdReply);

      const tdArch = document.createElement('td');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'archive-checkbox';
      cb.dataset.id = r.id;
      cb.checked = !!r.archived;
      tdArch.appendChild(cb);
      tr.appendChild(tdArch);

      return tr;
    }

    async function loadRequests(){
      const res = await fetch('/api/requests', { credentials:'include' });
      if (res.status === 401){
        loginCard.style.display = 'block';
        dashboardCard.style.display = 'none';
        return;
      }

      const data = await res.json();
      const active = data.filter(r => !r.archived);
      const archived = data.filter(r => r.archived);

      activeBody.innerHTML = '';
      archivedBody.innerHTML = '';

      if (!active.length) activeBody.innerHTML = '<tr><td colspan="11" style="padding:16px;">No active requests.</td></tr>';
      else active.forEach(r => activeBody.appendChild(renderRow(r)));

      if (!archived.length) archivedBody.innerHTML = '<tr><td colspan="11" style="padding:16px;">No archived requests.</td></tr>';
      else archived.forEach(r => archivedBody.appendChild(renderRow(r)));

      loginCard.style.display = 'none';
      dashboardCard.style.display = 'block';
      setMsg(dashboardStatus, 'Loaded ' + data.length + ' request(s).', true);
    }

    // LOGIN
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      setMsg(loginStatus, 'Signing in...', true);

      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;

      const res = await fetch('/api/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, password })
      });

      if (!res.ok){
        setMsg(loginStatus, 'Invalid email or password', false);
        return;
      }

      setMsg(loginStatus, 'Login successful. Loading dashboard...', true);
      loadRequests();
    });

    // LOGOUT
    logoutLink.addEventListener('click', async (e)=>{
      e.preventDefault();
      try{ await fetch('/api/logout', { method:'POST', credentials:'include' }); } catch(_){}
      loginCard.style.display = 'block';
      dashboardCard.style.display = 'none';
    });

    // SHEETS BUTTONS
    reloadBtn.addEventListener('click', async ()=>{
      setMsg(dashboardStatus, 'Refreshing from Google Sheets...', true);
      const res = await fetch('/api/sheets/reload', { method:'POST', credentials:'include' });
      const data = await res.json().catch(()=>({}));
      if (!res.ok) return setMsg(dashboardStatus, data.error || 'Reload failed', false);
      setMsg(dashboardStatus, 'Reloaded ' + (data.count || 0) + ' requests from Sheets.', true);
      loadRequests();
    });

    syncBtn.addEventListener('click', async ()=>{
      setMsg(dashboardStatus, 'Syncing to Google Sheets...', true);
      const res = await fetch('/api/sheets/sync', { method:'POST', credentials:'include' });
      const data = await res.json().catch(()=>({}));
      if (!res.ok) return setMsg(dashboardStatus, data.error || 'Sync failed', false);
      setMsg(dashboardStatus, 'Synced ' + (data.count || 0) + ' requests to Sheets.', true);
    });

    // Updates
    async function updateStatus(id, status){
      await fetch(`/api/requests/${id}/status`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ status })
      });
    }

    async function updateFulfilled(id, fulfilledBy){
      await fetch(`/api/requests/${id}/fulfilled`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ fulfilledBy })
      });
    }

    async function updateArchive(id, archived){
      await fetch(`/api/requests/${id}/archive`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ archived })
      });
    }

    async function saveAdminNotes(id, adminNotes){
      await fetch(`/api/requests/${id}/admin-notes`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ adminNotes })
      });
    }

    async function saveTracking(id, trackingNumber){
      await fetch(`/api/requests/${id}/tracking`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ trackingNumber })
      });
    }

    function onClick(e){
      const btn = e.target.closest('.reply-btn');
      if (!btn) return;

      const email = btn.dataset.email || '';
      const name = btn.dataset.name || '';
      const stl = btn.dataset.stl || '';

      const subject = 'LM3DPTFY Quote Reply';
      const body =
        'Hi ' + name + ',\n\n' +
        'Thanks for your quote request for:\n' +
        stl + '\n\n' +
        '— Let Me 3D Print That For You';

      window.open(buildGmailUrl(email, subject, body), '_blank');
    }

    // Debounced admin notes save
    let notesTimer = null;
    function onInput(e){
      const ta = e.target.closest('.admin-notes');
      if (!ta) return;
      const id = ta.dataset.id;
      const val = ta.value;

      clearTimeout(notesTimer);
      notesTimer = setTimeout(async () => {
        try{
          await saveAdminNotes(id, val);
          setMsg(dashboardStatus, 'Admin notes saved.', true);
        }catch(err){
          setMsg(dashboardStatus, 'Failed to save admin notes.', false);
        }
      }, 500);
    }

    // Tracking save + open email
    async function maybeSaveTrackingAndEmail(input){
      const id = input.dataset.id;
      const tracking = (input.value || '').trim();
      const prev = (input.dataset.prev || '').trim();

      if (tracking === prev) return;
      input.dataset.prev = tracking;

      try{
        await saveTracking(id, tracking);
        setMsg(dashboardStatus, 'Tracking # saved.', true);

        if (tracking){
          const email = input.dataset.email || '';
          const name = input.dataset.name || '';
          const subject = 'Your LM3DPTFY order has shipped';
          const body =
            'Hi ' + name + ',\n\n' +
            'Your order has shipped!\n\n' +
            'Tracking number: ' + tracking + '\n\n' +
            'Thanks!\n' +
            '— Let Me 3D Print That For You';

          window.open(buildGmailUrl(email, subject, body), '_blank');
        }
      }catch(err){
        setMsg(dashboardStatus, 'Failed to save tracking #.', false);
      }
    }

    function onBlur(e){
      const input = e.target.closest('.tracking-input');
      if (!input || input.disabled) return;
      maybeSaveTrackingAndEmail(input);
    }

    function onKeydown(e){
      const input = e.target.closest('.tracking-input');
      if (!input) return;
      if (e.key === 'Enter'){
        e.preventDefault();
        input.blur();
      }
    }

    async function onChange(e){
      const t = e.target;

      try{
        if (t.classList.contains('status-select')){
          await updateStatus(t.dataset.id, t.value);
          setMsg(dashboardStatus, 'Status updated.', true);
          // Re-render so tracking enables when shipped
          loadRequests();
          return;
        }

        if (t.classList.contains('fulfilled-select')){
          await updateFulfilled(t.dataset.id, t.value);
          setMsg(dashboardStatus, 'Fulfilled by updated.', true);
          return;
        }

        if (t.classList.contains('archive-checkbox')){
          await updateArchive(t.dataset.id, t.checked);
          loadRequests();
          return;
        }
      }catch(err){
        setMsg(dashboardStatus, 'Update failed.', false);
      }
    }

    activeBody.addEventListener('click', onClick);
    archivedBody.addEventListener('click', onClick);

    activeBody.addEventListener('input', onInput);
    archivedBody.addEventListener('input', onInput);

    activeBody.addEventListener('change', onChange);
    archivedBody.addEventListener('change', onChange);

    activeBody.addEventListener('blur', onBlur, true);
    archivedBody.addEventListener('blur', onBlur, true);

    activeBody.addEventListener('keydown', onKeydown);
    archivedBody.addEventListener('keydown', onKeydown);

    loadRequests();
  </script>
</body>
</html>
