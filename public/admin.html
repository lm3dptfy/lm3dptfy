<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Let Me 3D Print That For You · Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="page-shell">

    <header class="site-header">
      <div class="header-inner">
        <a class="brand" href="/">
          <img class="brand-logo" src="/lm3dptfy-logo-tp-cropped.png" alt="LM3DPTFY logo" />
          <span class="brand-text">
            <span class="brand-title">Let Me 3D Print That For You</span>
            <span class="brand-subtitle">Admin dashboard • Private</span>
          </span>
        </a>

        <nav class="nav-links">
          <a class="nav-link" href="/">Home</a>
          <button id="logoutBtnTop" class="nav-link" style="border:none;background:none;cursor:pointer;">
            Log out
          </button>
        </nav>
      </div>
    </header>

    <main class="page-main page-main--top">
      <div class="main-inner admin-main-inner">

        <div class="card hero-card" style="max-width:1100px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap;">
            <div>
              <h1 class="admin-header-text">Quote requests</h1>
              <p class="admin-subtitle">Active and archived requests from lm3dptfy.online.</p>
            </div>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <button id="reloadSheetsBtn" class="btn-primary is-inline" style="padding:10px 12px; font-size:0.9rem;">
                Refresh from Sheets
              </button>
              <button id="syncSheetsBtn" class="btn-primary is-inline" style="padding:10px 12px; font-size:0.9rem;">
                Sync to Sheets
              </button>
              <a href="/api/export/csv" class="btn-primary is-inline" style="padding:10px 12px; font-size:0.9rem; text-decoration:none; display:inline-block;">
                Export CSV
              </a>
              <a href="/api/export/json" class="btn-primary is-inline" style="padding:10px 12px; font-size:0.9rem; text-decoration:none; display:inline-block;">
                Export JSON
              </a>
            </div>
          </div>

          <p id="dashboardStatus" class="status-message" style="display:none;"></p>
        </div>

        <!-- ACTIVE -->
        <div class="card" style="max-width:1100px;">
          <div class="card-pad">
            <h2 class="info-title" style="margin:0;">Active</h2>
          </div>
          <div class="table-wrapper" style="margin-top:0; border-left:0; border-right:0; border-bottom:0; border-radius:0 0 22px 22px;">
            <table class="request-table">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>STL link</th>
                  <th>Customer Notes</th>
                  <th>Admin Notes</th>
                  <th>Status</th>
                  <th>Fulfilled By</th>
                  <th>Tracking #</th>
                  <th>Reply</th>
                  <th>Archive</th>
                </tr>
              </thead>
              <tbody id="activeBody">
                <tr>
                  <td colspan="11" style="text-align:center;padding:20px;">Loading…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ARCHIVED -->
        <div class="card" style="max-width:1100px;">
          <div class="card-pad">
            <h2 class="info-title" style="margin:0;">Archived</h2>
          </div>
          <div class="table-wrapper" style="margin-top:0; border-left:0; border-right:0; border-bottom:0; border-radius:0 0 22px 22px;">
            <table class="request-table">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>STL link</th>
                  <th>Customer Notes</th>
                  <th>Admin Notes</th>
                  <th>Status</th>
                  <th>Fulfilled By</th>
                  <th>Tracking #</th>
                  <th>Reply</th>
                  <th>Archive</th>
                </tr>
              </thead>
              <tbody id="archivedBody">
                <tr>
                  <td colspan="11" style="text-align:center;padding:20px;">No archived requests.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <p class="small-note" style="max-width:1100px;">
          Tip: Bookmark <b>/admin</b>. Tracking email opens automatically after you paste a tracking number (when Status is Shipped).
        </p>

      </div>
    </main>

    <footer class="site-footer">
      Let Me 3D Print That For You · Admin (Private)
    </footer>
  </div>

  <script>
    const activeBody = document.getElementById('activeBody');
    const archivedBody = document.getElementById('archivedBody');
    const dashboardStatus = document.getElementById('dashboardStatus');
    const logoutBtnTop = document.getElementById('logoutBtnTop');
    const reloadBtn = document.getElementById('reloadSheetsBtn');
    const syncBtn = document.getElementById('syncSheetsBtn');

    const STATUS_OPTIONS = [
      { value: 'new', label: 'New' },
      { value: 'responded', label: 'Responded' },
      { value: 'quote_approved', label: 'Quote approved' },
      { value: 'sent_to_printer', label: 'Sent to printer' },
      { value: 'print_complete', label: 'Print complete' },
      { value: 'qc_complete', label: 'QC complete' },
      { value: 'shipped', label: 'Shipped' },
      { value: 'paid', label: 'Paid' },
    ];

    const FULFILLED_BY_OPTIONS = [
      { value: '', label: '-- None --' },
      { value: 'Jared', label: 'Jared' },
      { value: 'Robert', label: 'Robert' },
      { value: 'Terence', label: 'Terence' }
    ];

    const GMAIL_AUTH_USER = 'lm3dptfy@gmail.com';

    function buildGmailUrl(toEmail, subject, body) {
      let url = 'https://mail.google.com/mail/?view=cm&fs=1&tf=1';
      url += '&authuser=' + encodeURIComponent(GMAIL_AUTH_USER);
      url += '&to=' + encodeURIComponent(toEmail);
      url += '&su=' + encodeURIComponent(subject);
      url += '&body=' + encodeURIComponent(body);
      return url;
    }

    function showDashStatus(msg, isError) {
      dashboardStatus.textContent = msg;
      dashboardStatus.style.display = 'block';
      dashboardStatus.classList.toggle('status-error', !!isError);
      dashboardStatus.classList.toggle('status-success', !isError);
      if (!isError) setTimeout(() => { dashboardStatus.style.display = 'none'; }, 5000);
    }

    function renderRow(r) {
      const tr = document.createElement('tr');

      const createdTd = document.createElement('td');
      createdTd.textContent = r.createdAt ? new Date(r.createdAt).toLocaleString() : '';
      tr.appendChild(createdTd);

      const nameTd = document.createElement('td');
      nameTd.textContent = r.name || '';
      tr.appendChild(nameTd);

      const emailTd = document.createElement('td');
      if (r.email) {
        const a = document.createElement('a');
        a.href = 'mailto:' + r.email;
        a.textContent = r.email;
        emailTd.appendChild(a);
      }
      tr.appendChild(emailTd);

      const stlTd = document.createElement('td');
      if (r.stlLink) {
        const a = document.createElement('a');
        a.href = r.stlLink;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'View STL';
        stlTd.appendChild(a);
      }
      tr.appendChild(stlTd);

      // Customer notes
      const notesTd = document.createElement('td');
      notesTd.textContent = r.details || '';
      tr.appendChild(notesTd);

      // Admin notes (editable)
      const adminNotesTd = document.createElement('td');
      const adminNotes = document.createElement('textarea');
      adminNotes.className = 'table-textarea admin-notes';
      adminNotes.dataset.id = r.id;
      adminNotes.value = r.adminNotes || '';
      adminNotes.placeholder = 'What did we email them?';
      adminNotesTd.appendChild(adminNotes);
      tr.appendChild(adminNotesTd);

      // Status
      const statusTd = document.createElement('td');
      const statusSelect = document.createElement('select');
      statusSelect.className = 'status-select';
      statusSelect.dataset.id = r.id;
      STATUS_OPTIONS.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        if ((r.status || 'new') === opt.value) o.selected = true;
        statusSelect.appendChild(o);
      });
      statusTd.appendChild(statusSelect);
      tr.appendChild(statusTd);

      // Fulfilled by
      const fulfilledTd = document.createElement('td');
      const fulfilledSelect = document.createElement('select');
      fulfilledSelect.className = 'status-select fulfilled-select';
      fulfilledSelect.dataset.id = r.id;
      FULFILLED_BY_OPTIONS.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        if ((r.fulfilledBy || '') === opt.value) o.selected = true;
        fulfilledSelect.appendChild(o);
      });
      fulfilledTd.appendChild(fulfilledSelect);
      tr.appendChild(fulfilledTd);

      // Tracking # (editable; enabled only if shipped)
      const trackingTd = document.createElement('td');
      const trackingInput = document.createElement('input');
      trackingInput.type = 'text';
      trackingInput.className = 'table-input tracking-input';
      trackingInput.dataset.id = r.id;
      trackingInput.dataset.email = r.email || '';
      trackingInput.dataset.name = r.name || '';
      trackingInput.value = r.trackingNumber || '';
      trackingInput.placeholder = 'Paste tracking…';
      trackingInput.disabled = (r.status !== 'shipped');
      trackingTd.appendChild(trackingInput);
      tr.appendChild(trackingTd);

      // Reply button (manual)
      const replyTd = document.createElement('td');
      const replyBtn = document.createElement('button');
      replyBtn.className = 'link-btn reply-btn';
      replyBtn.dataset.email = r.email || '';
      replyBtn.dataset.name = r.name || '';
      replyBtn.dataset.stl = r.stlLink || '';
      replyBtn.textContent = 'Reply';
      replyTd.appendChild(replyBtn);
      tr.appendChild(replyTd);

      // Archive
      const archiveTd = document.createElement('td');
      const archiveCheckbox = document.createElement('input');
      archiveCheckbox.type = 'checkbox';
      archiveCheckbox.className = 'archive-checkbox';
      archiveCheckbox.dataset.id = r.id;
      archiveCheckbox.checked = !!r.archived;
      archiveTd.appendChild(archiveCheckbox);
      tr.appendChild(archiveTd);

      return tr;
    }

    async function loadRequests() {
      try {
        const res = await fetch('/api/requests', { credentials: 'include' });
        if (res.status === 401) {
          window.location.replace('/admin');
          return;
        }

        const data = await res.json();
        const active = data.filter(r => !r.archived);
        const archived = data.filter(r => r.archived);

        activeBody.innerHTML = '';
        archivedBody.innerHTML = '';

        if (active.length === 0) {
          activeBody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:20px;">No active requests.</td></tr>';
        } else {
          active.forEach(r => activeBody.appendChild(renderRow(r)));
        }

        if (archived.length === 0) {
          archivedBody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:20px;">No archived requests.</td></tr>';
        } else {
          archived.forEach(r => archivedBody.appendChild(renderRow(r)));
        }

        showDashStatus('Loaded ' + data.length + ' request(s).', false);
      } catch (err) {
        console.error('Error loading requests:', err);
        showDashStatus('Error loading requests: ' + err.message, true);
      }
    }

    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
      } catch (e) {}
      window.location.replace('/admin');
    }

    logoutBtnTop.addEventListener('click', logout);

    reloadBtn.addEventListener('click', async () => {
      showDashStatus('Refreshing from Google Sheets...', false);
      try {
        const res = await fetch('/api/sheets/reload', { method: 'POST', credentials: 'include' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Reload failed');
        showDashStatus('Reloaded ' + (data.count || 0) + ' requests from Sheets.', false);
        loadRequests();
      } catch (err) {
        showDashStatus('Reload failed: ' + err.message, true);
      }
    });

    syncBtn.addEventListener('click', async () => {
      showDashStatus('Syncing to Google Sheets...', false);
      try {
        const res = await fetch('/api/sheets/sync', { method: 'POST', credentials: 'include' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Sync failed');
        showDashStatus('Synced ' + (data.count || 0) + ' requests to Sheets.', false);
      } catch (err) {
        showDashStatus('Sync failed: ' + err.message, true);
      }
    });

    function handleStatusChange(e) {
      const select = e.target.closest('.status-select');
      if (!select || select.classList.contains('fulfilled-select')) return;

      const id = select.dataset.id;
      const status = select.value;

      showDashStatus('Updating status...', false);

      fetch(`/api/requests/${id}/status`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status }),
      })
        .then(res => { if (!res.ok) throw new Error('Failed to update status'); })
        .then(() => {
          showDashStatus('Status updated.', false);
          // refresh rows so tracking input enables when shipped
          loadRequests();
        })
        .catch(err => showDashStatus('Error updating status: ' + err.message, true));
    }

    function handleFulfilledChange(e) {
      const select = e.target.closest('.fulfilled-select');
      if (!select) return;

      const id = select.dataset.id;
      const fulfilledBy = select.value;

      showDashStatus('Updating fulfilled by...', false);

      fetch(`/api/requests/${id}/fulfilled`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fulfilledBy }),
      })
        .then(res => { if (!res.ok) throw new Error('Failed to update fulfilled by'); })
        .then(() => showDashStatus('Fulfilled by updated.', false))
        .catch(err => showDashStatus('Error updating fulfilled by: ' + err.message, true));
    }

    function handleAdminNotesChange(e) {
      const ta = e.target.closest('.admin-notes');
      if (!ta) return;

      const id = ta.dataset.id;
      const adminNotes = ta.value || '';

      showDashStatus('Saving admin notes...', false);

      fetch(`/api/requests/${id}/admin_notes`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adminNotes }),
      })
        .then(res => { if (!res.ok) throw new Error('Failed to save admin notes'); })
        .then(() => showDashStatus('Admin notes saved.', false))
        .catch(err => showDashStatus('Error saving notes: ' + err.message, true));
    }

    function handleTrackingChange(e) {
      const input = e.target.closest('.tracking-input');
      if (!input) return;

      const id = input.dataset.id;
      const trackingNumber = (input.value || '').trim();
      const toEmail = input.dataset.email || '';
      const name = input.dataset.name || '';

      if (!trackingNumber) return;

      // Open a window synchronously (avoids popup blockers), then navigate it after save.
      // Only do the email-open behavior if the input is enabled (i.e., status is shipped).
      const shouldOpenEmail = !input.disabled && !!toEmail;
      const popup = shouldOpenEmail ? window.open('about:blank', '_blank') : null;

      showDashStatus('Saving tracking number...', false);

      fetch(`/api/requests/${id}/tracking`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ trackingNumber }),
      })
        .then(async res => {
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || 'Failed to save tracking number');
          }
        })
        .then(() => {
          showDashStatus('Tracking number saved.', false);

          if (shouldOpenEmail && popup) {
            const subject = `Your LM3DPTFY order has shipped (Tracking: ${trackingNumber})`;
            const body =
              `Hi ${name || ''},\n\n` +
              `Good news — your LM3DPTFY print has shipped!\n\n` +
              `Tracking number: ${trackingNumber}\n\n` +
              `Thanks,\nLM3DPTFY`;
            popup.location = buildGmailUrl(toEmail, subject, body);
          }
        })
        .catch(err => {
          showDashStatus('Error saving tracking: ' + err.message, true);
          if (popup) popup.close();
        });
    }

    function handleArchiveChange(e) {
      const checkbox = e.target.closest('.archive-checkbox');
      if (!checkbox) return;

      const id = checkbox.dataset.id;
      const archived = checkbox.checked;

      showDashStatus(archived ? 'Archiving request...' : 'Unarchiving request...', false);

      fetch(`/api/requests/${id}/archive`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ archived }),
      })
        .then(res => { if (!res.ok) throw new Error('Failed to update archive state'); })
        .then(() => {
          showDashStatus(archived ? 'Request archived.' : 'Request unarchived.', false);
          loadRequests();
        })
        .catch(err => showDashStatus('Error updating archive: ' + err.message, true));
    }

    function handleReplyClick(e) {
      const btn = e.target.closest('.reply-btn');
      if (!btn) return;

      const email = btn.dataset.email;
      if (!email) return;

      const name = btn.dataset.name || '';
      const stl = btn.dataset.stl || '';
      const subject = 'LM3DPTFY Quote Reply';
      const body =
        'Hi ' + name + ',\n\n' +
        'Thanks for your quote request for:\n' +
        stl + '\n\n' +
        '— LM3DPTFY';

      window.open(buildGmailUrl(email, subject, body), '_blank');
    }

    activeBody.addEventListener('change', handleStatusChange);
    archivedBody.addEventListener('change', handleStatusChange);

    activeBody.addEventListener('change', handleFulfilledChange);
    archivedBody.addEventListener('change', handleFulfilledChange);

    activeBody.addEventListener('change', handleAdminNotesChange);
    archivedBody.addEventListener('change', handleAdminNotesChange);

    activeBody.addEventListener('change', handleTrackingChange);
    archivedBody.addEventListener('change', handleTrackingChange);

    activeBody.addEventListener('change', handleArchiveChange);
    archivedBody.addEventListener('change', handleArchiveChange);

    activeBody.addEventListener('click', handleReplyClick);
    archivedBody.addEventListener('click', handleReplyClick);

    loadRequests();
  </script>
</body>
</html>
