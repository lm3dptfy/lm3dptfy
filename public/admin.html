<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin | LM3DPTFY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Cache-bust so you SEE the update immediately -->
  <link rel="stylesheet" href="/style.css?v=admin6" />

  <style>
    /* Admin-only layout helpers (keeps everything stacked + clean) */
    .admin-wrap { width:100%; max-width: 1220px; margin: 0 auto; }

    .settings-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin: 14px 0 6px;
    }
    @media (max-width: 980px){
      .settings-grid{ grid-template-columns: 1fr; }
    }

    .settings-card{
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .settings-card h3{
      margin:0 0 4px;
      font-size: 1.0rem;
      letter-spacing:-.01em;
    }
    .settings-card p{
      margin:0;
      color:var(--muted);
      font-size:.92rem;
      line-height:1.35;
    }

    .orders-section{
      margin-top:14px;
    }

    .order-card{
      padding:16px;
      margin-top:12px;
    }

    .order-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .order-meta{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
    }

    .order-created{
      font-size:.90rem;
      color:var(--muted);
    }

    .order-name{
      font-size:1.35rem;
      font-weight:850;
      letter-spacing:-.02em;
      line-height:1.1;
      margin:0;
    }

    .order-email a{
      color: var(--accent);
      text-decoration:none;
      font-weight:650;
    }
    .order-email a:hover{ text-decoration:underline; }

    /* Source pill */
    :root{
      --danger:#e11d48;
      --danger2:#fb7185;
    }

    .source-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      width: fit-content;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.70);
      color: var(--muted);
      font-size:.85rem;
      font-weight: 750;
      letter-spacing:.01em;
    }
    .source-pill.is-unsupported{
      color: var(--danger);
      border-color: rgba(225,29,72,.30);
      background: rgba(225,29,72,.08);
    }

    /* Red button variant for unsupported links */
    .btn-danger{
      background: linear-gradient(180deg, var(--danger2), var(--danger)) !important;
      box-shadow: 0 14px 34px rgba(225,29,72,.22) !important;
    }
    .btn-danger:hover{
      box-shadow: 0 18px 44px rgba(225,29,72,.28) !important;
      filter: brightness(1.02);
    }

    .order-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .archive-wrap{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      color: var(--muted);
      font-size:.88rem;
      font-weight:650;
    }

    .order-body{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .order-body{ grid-template-columns: 1fr; }
    }

    .order-box{
      border:1px solid rgba(15,23,42,.08);
      border-radius: var(--radiusLG);
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.72));
      box-shadow: var(--shadowSoft);
      padding:14px;
      min-width:0;
    }

    .order-box h4{
      margin:0 0 10px;
      font-size:.9rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(100,116,139,.95);
    }

    .kv{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:10px;
      align-items:center;
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
    }

    .row label{
      color: var(--muted);
      font-weight:700;
      font-size:.9rem;
    }

    .btn-ghost{
      border:1px solid var(--border);
      background: rgba(255,255,255,.7);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      cursor:pointer;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
      padding: 18px;
    }
    .modal{
      width: min(860px, 100%);
      background: #fff;
      border-radius: var(--radiusXL);
      border:1px solid var(--border);
      box-shadow: 0 28px 90px rgba(15,23,42,.25);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(246,248,252,.9);
      backdrop-filter: blur(10px);
    }
    .modal-head h3{
      margin:0;
      font-size:1.0rem;
      letter-spacing:-.01em;
    }
    .modal-body{
      padding:16px;
    }
    .modal-actions{
      padding:14px 16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      background: rgba(246,248,252,.9);
    }

    .site-row{
      display:grid;
      grid-template-columns: 1fr 1.2fr 1.4fr auto;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    @media (max-width: 860px){
      .site-row{ grid-template-columns: 1fr; }
    }
    .site-row .field-input{ padding:10px 12px; border-radius: 14px; }
  </style>
</head>

<body class="admin-page">
  <div class="page-shell">

    <!-- Top bar -->
    <header class="topbar">
      <div class="topbar-inner">
        <a class="brand" href="/" title="Home">
          <img src="/lm3dptfy-logo-tp-cropped.png" alt="LM3DPTFY logo" />
          <div class="brand-title">
            <strong>Let Me 3D Print That For You</strong>
            <span>Admin dashboard • Private</span>
          </div>
        </a>

        <div class="nav-right">
          <a class="pill-link" href="/">Home</a>
          <button id="logoutTopBtn" class="pill-link" type="button">Log out</button>
        </div>
      </div>
    </header>

    <main class="page-main">
      <div class="main-inner admin-wrap">

        <!-- Login -->
        <div id="loginCard" class="card" style="max-width:560px;margin:0 auto;padding:18px;">
          <h1 class="admin-title" style="font-size:1.25rem;margin:0 0 6px;">Admin login</h1>
          <p class="admin-subtitle" style="margin:0 0 14px;">Sign in to see and manage quote requests.</p>

          <form id="loginForm" class="stl-form">
            <div>
              <label for="adminEmail" class="field-label">Admin email</label>
              <input type="email" id="adminEmail" class="field-input" required />
            </div>
            <div>
              <label for="adminPassword" class="field-label">Password</label>
              <input type="password" id="adminPassword" class="field-input" required />
            </div>
            <button type="submit" class="btn-primary">Log in</button>
            <p id="loginStatus" class="status-message" style="display:none;"></p>
          </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboardCard" style="display:none;">
          <div class="admin-head">
            <div>
              <h1 class="admin-title">Quote requests</h1>
              <p class="admin-subtitle">Active + archived requests from lm3dptfy.online.</p>
            </div>

            <div class="admin-actions">
              <button id="reloadSheetsBtn" class="btn-primary btn-sm" type="button">Refresh from Sheets</button>
              <button id="syncSheetsBtn" class="btn-primary btn-sm" type="button">Sync to Sheets</button>
              <a href="/api/export/csv" class="btn-primary btn-sm" style="text-decoration:none;">Export CSV</a>
              <a href="/api/export/json" class="btn-primary btn-sm" style="text-decoration:none;">Export JSON</a>
            </div>
          </div>

          <p id="dashboardStatus" class="status-message" style="display:none;"></p>

          <!-- Settings -->
          <section class="settings-grid">
            <div class="card settings-card">
              <div>
                <h3>Fulfilled by list</h3>
                <p>These names appear in the “Fulfilled by” dropdown on each order.</p>
              </div>
              <button id="editFulfilledBtn" class="btn-primary btn-sm" type="button">Edit</button>
            </div>

            <div class="card settings-card">
              <div>
                <h3>Supported sites</h3>
                <p>These sites appear on the Home page and power source detection.</p>
              </div>
              <button id="editSitesBtn" class="btn-primary btn-sm" type="button">Edit</button>
            </div>
          </section>

          <!-- Active -->
          <section class="orders-section">
            <div class="card" style="padding:16px;">
              <h2 class="section-title" style="margin:0;">Active</h2>
              <div id="activeList" style="margin-top:10px;"></div>
              <p class="tip">Tip: Set status to <strong>Shipped</strong> to enable Tracking #. When you paste tracking, an email draft opens automatically.</p>
            </div>
          </section>

          <!-- Archived -->
          <section class="orders-section">
            <div class="card" style="padding:16px;">
              <h2 class="section-title" style="margin:0;">Archived</h2>
              <div id="archivedList" style="margin-top:10px;"></div>
              <p class="tip">Tip: Bookmark <strong>/admin</strong>. This page is meant to stay private.</p>
            </div>
          </section>

        </div>
      </div>
    </main>

    <footer class="site-footer">
      LM3DPTFY Admin · Keep this page private.
    </footer>
  </div>

  <!-- Modal: Fulfilled By -->
  <div id="modalFulfilled" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Edit fulfilled by list">
    <div class="modal">
      <div class="modal-head">
        <h3>Edit “Fulfilled by” names</h3>
        <button class="btn-ghost" type="button" data-close="modalFulfilled">Close</button>
      </div>
      <div class="modal-body">
        <p style="margin:0 0 10px; color:var(--muted); font-size:.92rem; line-height:1.45;">
          Enter one name per line.
        </p>
        <textarea id="fulfilledTextarea" class="field-input" rows="7" placeholder="Robert&#10;Jared&#10;Terence"></textarea>
        <p id="fulfilledStatus" class="status-message" style="display:none;"></p>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" type="button" data-close="modalFulfilled">Cancel</button>
        <button id="saveFulfilledBtn" class="btn-primary" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Modal: Supported Sites -->
  <div id="modalSites" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Edit supported sites">
    <div class="modal">
      <div class="modal-head">
        <h3>Edit Supported Sites</h3>
        <button class="btn-ghost" type="button" data-close="modalSites">Close</button>
      </div>
      <div class="modal-body">
        <p style="margin:0 0 10px; color:var(--muted); font-size:.92rem; line-height:1.45;">
          Add sites you support. “Hosts” should be comma-separated domains (ex: <strong>stlflix.com</strong>).
        </p>

        <div id="sitesEditor"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button id="addSiteRowBtn" class="btn-ghost" type="button">+ Add site</button>
        </div>

        <p id="sitesStatus" class="status-message" style="display:none;"></p>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" type="button" data-close="modalSites">Cancel</button>
        <button id="saveSitesBtn" class="btn-primary" type="button">Save</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // ELEMENTS
    // =========================
    const loginForm = document.getElementById('loginForm');
    const loginStatus = document.getElementById('loginStatus');
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const dashboardStatus = document.getElementById('dashboardStatus');

    const reloadBtn = document.getElementById('reloadSheetsBtn');
    const syncBtn = document.getElementById('syncSheetsBtn');
    const logoutTopBtn = document.getElementById('logoutTopBtn');

    const activeList = document.getElementById('activeList');
    const archivedList = document.getElementById('archivedList');

    const editFulfilledBtn = document.getElementById('editFulfilledBtn');
    const editSitesBtn = document.getElementById('editSitesBtn');

    const modalFulfilled = document.getElementById('modalFulfilled');
    const modalSites = document.getElementById('modalSites');

    const fulfilledTextarea = document.getElementById('fulfilledTextarea');
    const saveFulfilledBtn = document.getElementById('saveFulfilledBtn');
    const fulfilledStatus = document.getElementById('fulfilledStatus');

    const sitesEditor = document.getElementById('sitesEditor');
    const addSiteRowBtn = document.getElementById('addSiteRowBtn');
    const saveSitesBtn = document.getElementById('saveSitesBtn');
    const sitesStatus = document.getElementById('sitesStatus');

    // =========================
    // CONSTANTS
    // =========================
    const STATUS_OPTIONS = [
      { value: 'new', label: 'New' },
      { value: 'responded', label: 'Responded' },
      { value: 'quote_approved', label: 'Quote approved' },
      { value: 'sent_to_printer', label: 'Sent to printer' },
      { value: 'print_complete', label: 'Print complete' },
      { value: 'qc_complete', label: 'QC complete' },
      { value: 'shipped', label: 'Shipped' },
      { value: 'paid', label: 'Paid' },
    ];

    const GMAIL_AUTH_USER = 'lm3dptfy@gmail.com';

    // Settings state (loaded from server)
    let fulfilledByNames = ['Jared', 'Robert', 'Terence'];
    let supportedSites = [
      { name: 'STLFlix', browseUrl: 'https://stlflix.com', hosts: ['stlflix.com'] }
    ];

    // =========================
    // HELPERS
    // =========================
    function showDashStatus(msg, isError){
      dashboardStatus.textContent = msg;
      dashboardStatus.style.display = 'block';
      dashboardStatus.classList.toggle('status-error', !!isError);
      dashboardStatus.classList.toggle('status-success', !isError);
      if (!isError) setTimeout(() => { dashboardStatus.style.display = 'none'; }, 4500);
    }

    function buildGmailUrl(toEmail, subject, body){
      let url = 'https://mail.google.com/mail/?view=cm&fs=1&tf=1';
      url += '&authuser=' + encodeURIComponent(GMAIL_AUTH_USER);
      url += '&to=' + encodeURIComponent(toEmail);
      url += '&su=' + encodeURIComponent(subject);
      url += '&body=' + encodeURIComponent(body);
      return url;
    }

    function openModal(el){ el.style.display = 'flex'; }
    function closeModal(el){ el.style.display = 'none'; }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-close]');
      if (!btn) return;
      const id = btn.getAttribute('data-close');
      const el = document.getElementById(id);
      if (el) closeModal(el);
    });

    function normalizeHost(host){
      return String(host || '').trim().toLowerCase().replace(/^www\./,'');
    }

    function detectSourceForLink(stlLink){
      try{
        const host = normalizeHost(new URL(stlLink).hostname);
        for (const s of supportedSites){
          const hosts = Array.isArray(s.hosts) ? s.hosts.map(normalizeHost) : [];
          if (hosts.includes(host)) return { name: s.name || 'Supported', supported: true };
          for (const h of hosts){
            if (h && host.endsWith('.' + h)) return { name: s.name || 'Supported', supported: true };
          }
        }
        return { name: 'Unknown', supported: false };
      } catch {
        return { name: 'Unknown', supported: false };
      }
    }

    async function loadSettings(){
      // Uses your newer endpoints if present. If not present, it safely falls back to defaults.
      try{
        const res = await fetch('/api/settings', { credentials: 'include' });
        if (!res.ok) return;

        const data = await res.json().catch(() => ({}));
        if (Array.isArray(data.fulfilledByNames) && data.fulfilledByNames.length){
          fulfilledByNames = data.fulfilledByNames.filter(Boolean).map(s => String(s).trim()).filter(Boolean);
        }
        if (Array.isArray(data.supportedSites)){
          supportedSites = data.supportedSites.map(s => ({
            name: String(s.name || '').trim(),
            browseUrl: String(s.browseUrl || '').trim(),
            hosts: Array.isArray(s.hosts) ? s.hosts.map(h => String(h).trim()).filter(Boolean) : [],
          })).filter(s => s.name);
        }
      } catch {}
    }

    // =========================
    // SETTINGS MODALS
    // =========================
    function openFulfilledEditor(){
      fulfilledStatus.style.display = 'none';
      fulfilledTextarea.value = fulfilledByNames.join('\n');
      openModal(modalFulfilled);
    }

    function createSiteRow(site = { name:'', browseUrl:'', hosts:[] }){
      const row = document.createElement('div');
      row.className = 'site-row';

      const name = document.createElement('input');
      name.className = 'field-input';
      name.placeholder = 'Site name (ex: STLFlix)';
      name.value = site.name || '';

      const url = document.createElement('input');
      url.className = 'field-input';
      url.placeholder = 'Browse URL (ex: https://stlflix.com)';
      url.value = site.browseUrl || '';

      const hosts = document.createElement('input');
      hosts.className = 'field-input';
      hosts.placeholder = 'Hosts (comma-separated, ex: stlflix.com)';
      hosts.value = (Array.isArray(site.hosts) ? site.hosts : []).join(', ');

      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'btn-ghost';
      del.textContent = 'Remove';
      del.addEventListener('click', () => row.remove());

      row.appendChild(name);
      row.appendChild(url);
      row.appendChild(hosts);
      row.appendChild(del);

      return row;
    }

    function openSitesEditor(){
      sitesStatus.style.display = 'none';
      sitesEditor.innerHTML = '';
      (supportedSites.length ? supportedSites : []).forEach(s => sitesEditor.appendChild(createSiteRow(s)));
      if (!supportedSites.length) sitesEditor.appendChild(createSiteRow());
      openModal(modalSites);
    }

    editFulfilledBtn.addEventListener('click', openFulfilledEditor);
    editSitesBtn.addEventListener('click', openSitesEditor);

    addSiteRowBtn.addEventListener('click', () => {
      sitesEditor.appendChild(createSiteRow());
    });

    saveFulfilledBtn.addEventListener('click', async () => {
      const names = fulfilledTextarea.value
        .split('\n')
        .map(s => s.trim())
        .filter(Boolean);

      fulfilledStatus.style.display = 'block';
      fulfilledStatus.textContent = 'Saving...';
      fulfilledStatus.classList.remove('status-error', 'status-success');

      try{
        const res = await fetch('/api/settings/fulfilled-by', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ names }),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Request failed');

        fulfilledByNames = names;
        fulfilledStatus.textContent = '✓ Saved';
        fulfilledStatus.classList.add('status-success');

        setTimeout(() => closeModal(modalFulfilled), 450);
        await loadRequests(); // refresh dropdowns
      } catch(err){
        fulfilledStatus.textContent = '✗ ' + err.message;
        fulfilledStatus.classList.add('status-error');
      }
    });

    saveSitesBtn.addEventListener('click', async () => {
      const rows = Array.from(sitesEditor.querySelectorAll('.site-row'));
      const sites = rows.map(r => {
        const inputs = r.querySelectorAll('input');
        const name = (inputs[0]?.value || '').trim();
        const browseUrl = (inputs[1]?.value || '').trim();
        const hosts = (inputs[2]?.value || '')
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        return { name, browseUrl, hosts };
      }).filter(s => s.name);

      sitesStatus.style.display = 'block';
      sitesStatus.textContent = 'Saving...';
      sitesStatus.classList.remove('status-error', 'status-success');

      try{
        const res = await fetch('/api/settings/supported-sites', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ sites }),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Request failed');

        supportedSites = sites;
        sitesStatus.textContent = '✓ Saved';
        sitesStatus.classList.add('status-success');

        setTimeout(() => closeModal(modalSites), 450);
        await loadRequests(); // refresh source detection
      } catch(err){
        sitesStatus.textContent = '✗ ' + err.message;
        sitesStatus.classList.add('status-error');
      }
    });

    // =========================
    // ORDER RENDER
    // =========================
    function buildFulfilledOptions(selected){
      const opts = [];
      opts.push({ value:'', label:'-- None --' });
      fulfilledByNames.forEach(n => opts.push({ value:n, label:n }));
      return opts.map(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;
        if ((selected || '') === o.value) opt.selected = true;
        return opt;
      });
    }

    function buildStatusOptions(selected){
      return STATUS_OPTIONS.map(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;
        if ((selected || 'new') === o.value) opt.selected = true;
        return opt;
      });
    }

    function renderOrderCard(r){
      const wrap = document.createElement('div');
      wrap.className = 'card order-card';

      const created = r.createdAt ? new Date(r.createdAt).toLocaleString() : '';
      const name = r.name || '';
      const email = r.email || '';
      const stlLink = r.stlLink || '';
      const details = r.details || '';
      const adminNotes = r.adminNotes || '';
      const status = r.status || 'new';
      const fulfilledBy = r.fulfilledBy || '';
      const trackingNumber = r.trackingNumber || '';
      const archived = !!r.archived;

      // Source (prefer server if it provides it, else compute)
      let sourceName = (r.sourceName || r.source || r.sourceLabel || '').trim();
      let sourceSupported = (r.sourceSupported ?? r.isSourceSupported);

      if (!sourceName){
        const detected = detectSourceForLink(stlLink);
        sourceName = detected.name;
        sourceSupported = detected.supported;
      }

      const isUnsupported = (sourceSupported === false) || /unknown/i.test(sourceName);

      // TOP
      const top = document.createElement('div');
      top.className = 'order-top';

      const meta = document.createElement('div');
      meta.className = 'order-meta';

      const createdEl = document.createElement('div');
      createdEl.className = 'order-created';
      createdEl.textContent = created;

      const nameEl = document.createElement('h3');
      nameEl.className = 'order-name';
      nameEl.textContent = name;

      const emailEl = document.createElement('div');
      emailEl.className = 'order-email';
      if (email){
        const a = document.createElement('a');
        a.href = 'mailto:' + email;
        a.textContent = email;
        emailEl.appendChild(a);
      }

      const sourcePill = document.createElement('div');
      sourcePill.className = 'source-pill' + (isUnsupported ? ' is-unsupported' : '');
      sourcePill.textContent = 'Source: ' + (sourceName || 'Unknown');

      meta.appendChild(createdEl);
      meta.appendChild(nameEl);
      meta.appendChild(emailEl);
      meta.appendChild(sourcePill);

      const actions = document.createElement('div');
      actions.className = 'order-actions';

      const viewBtn = document.createElement('a');
      viewBtn.href = stlLink || '#';
      viewBtn.target = '_blank';
      viewBtn.rel = 'noopener noreferrer';
      viewBtn.className = 'btn-primary btn-sm' + (isUnsupported ? ' btn-danger' : '');
      viewBtn.textContent = 'View model';
      if (!stlLink){
        viewBtn.style.opacity = '0.55';
        viewBtn.style.pointerEvents = 'none';
      }

      const replyBtn = document.createElement('button');
      replyBtn.type = 'button';
      replyBtn.className = 'btn-primary btn-sm';
      replyBtn.textContent = 'Reply';
      replyBtn.addEventListener('click', () => {
        if (!email) return;
        const subject = 'LM3DPTFY Quote Reply';
        const body =
          'Hi ' + name + ',\n\n' +
          'Thanks for your quote request.\n\n' +
          (stlLink ? ('Model link:\n' + stlLink + '\n\n') : '') +
          '— LM3DPTFY';
        window.open(buildGmailUrl(email, subject, body), '_blank');
      });

      const archiveWrap = document.createElement('label');
      archiveWrap.className = 'archive-wrap';
      const archiveCb = document.createElement('input');
      archiveCb.type = 'checkbox';
      archiveCb.checked = archived;
      archiveCb.addEventListener('change', async () => {
        showDashStatus(archiveCb.checked ? 'Archiving...' : 'Unarchiving...', false);
        try{
          const res = await fetch(`/api/requests/${encodeURIComponent(r.id)}/archive`, {
            method:'POST',
            credentials:'include',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ archived: archiveCb.checked }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || 'Request failed');
          await loadRequests();
        } catch(err){
          showDashStatus('Archive update failed: ' + err.message, true);
          archiveCb.checked = !archiveCb.checked;
        }
      });
      const archiveTxt = document.createElement('span');
      archiveTxt.textContent = 'Archive';
      archiveWrap.appendChild(archiveCb);
      archiveWrap.appendChild(archiveTxt);

      actions.appendChild(viewBtn);
      actions.appendChild(replyBtn);
      actions.appendChild(archiveWrap);

      top.appendChild(meta);
      top.appendChild(actions);

      // BODY
      const body = document.createElement('div');
      body.className = 'order-body';

      const left = document.createElement('div');
      left.className = 'order-box';
      left.innerHTML = `<h4>Notes</h4>`;
      const leftKv = document.createElement('div');
      leftKv.className = 'kv';

      // Customer notes (read)
      const custRow = document.createElement('div');
      custRow.className = 'row';
      const custLab = document.createElement('label');
      custLab.textContent = 'Customer notes';
      const custVal = document.createElement('div');
      custVal.style.color = 'var(--text)';
      custVal.style.lineHeight = '1.45';
      custVal.style.whiteSpace = 'pre-wrap';
      custVal.textContent = details || '(none)';
      custRow.appendChild(custLab);
      custRow.appendChild(custVal);

      // Admin notes (edit)
      const adminRow = document.createElement('div');
      adminRow.className = 'row';
      const adminLab = document.createElement('label');
      adminLab.textContent = 'Admin notes';
      const adminInput = document.createElement('textarea');
      adminInput.className = 'field-input';
      adminInput.rows = 3;
      adminInput.placeholder = 'What did we email the user?';
      adminInput.value = adminNotes;

      adminInput.addEventListener('blur', async () => {
        try{
          await fetch(`/api/requests/${encodeURIComponent(r.id)}/admin-notes`, {
            method:'POST',
            credentials:'include',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ adminNotes: adminInput.value || '' }),
          });
        } catch {}
      });

      adminRow.appendChild(adminLab);
      adminRow.appendChild(adminInput);

      leftKv.appendChild(custRow);
      leftKv.appendChild(adminRow);
      left.appendChild(leftKv);

      const right = document.createElement('div');
      right.className = 'order-box';
      right.innerHTML = `<h4>Order</h4>`;
      const rightKv = document.createElement('div');
      rightKv.className = 'kv';

      // Status
      const statusRow = document.createElement('div');
      statusRow.className = 'row';
      const statusLab = document.createElement('label');
      statusLab.textContent = 'Status';
      const statusSel = document.createElement('select');
      statusSel.className = 'field-input';
      buildStatusOptions(status).forEach(o => statusSel.appendChild(o));
      statusSel.addEventListener('change', async () => {
        showDashStatus('Updating status...', false);
        try{
          const res = await fetch(`/api/requests/${encodeURIComponent(r.id)}/status`, {
            method:'POST',
            credentials:'include',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ status: statusSel.value }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || 'Request failed');

          // enable/disable tracking in-place
          const isShipped = statusSel.value === 'shipped';
          trackingInput.disabled = !isShipped;
          trackingInput.placeholder = isShipped ? 'Paste tracking' : 'Set status to Shipped';

          showDashStatus('Status updated.', false);
        } catch(err){
          showDashStatus('Status update failed: ' + err.message, true);
        }
      });
      statusRow.appendChild(statusLab);
      statusRow.appendChild(statusSel);

      // Fulfilled by
      const fulfillRow = document.createElement('div');
      fulfillRow.className = 'row';
      const fulfillLab = document.createElement('label');
      fulfillLab.textContent = 'Fulfilled by';
      const fulfillSel = document.createElement('select');
      fulfillSel.className = 'field-input';
      buildFulfilledOptions(fulfilledBy).forEach(o => fulfillSel.appendChild(o));
      fulfillSel.addEventListener('change', async () => {
        showDashStatus('Updating fulfilled by...', false);
        try{
          const res = await fetch(`/api/requests/${encodeURIComponent(r.id)}/fulfilled`, {
            method:'POST',
            credentials:'include',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ fulfilledBy: fulfillSel.value }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || 'Request failed');
          showDashStatus('Fulfilled by updated.', false);
        } catch(err){
          showDashStatus('Fulfilled update failed: ' + err.message, true);
        }
      });
      fulfillRow.appendChild(fulfillLab);
      fulfillRow.appendChild(fulfillSel);

      // Tracking
      const trackingRow = document.createElement('div');
      trackingRow.className = 'row';
      const trackingLab = document.createElement('label');
      trackingLab.textContent = 'Tracking #';
      const trackingInput = document.createElement('input');
      trackingInput.className = 'field-input';
      trackingInput.value = trackingNumber;
      trackingInput.placeholder = (status === 'shipped') ? 'Paste tracking' : 'Set status to Shipped';
      trackingInput.disabled = (status !== 'shipped');

      trackingInput.addEventListener('blur', async () => {
        try{
          await fetch(`/api/requests/${encodeURIComponent(r.id)}/tracking`, {
            method:'POST',
            credentials:'include',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ trackingNumber: trackingInput.value || '' }),
          });
        } catch {}
      });

      trackingInput.addEventListener('paste', () => {
        if (trackingInput.disabled) return;
        setTimeout(async () => {
          const val = (trackingInput.value || '').trim();
          if (!val) return;

          // Save then open email draft
          try{
            await fetch(`/api/requests/${encodeURIComponent(r.id)}/tracking`, {
              method:'POST',
              credentials:'include',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ trackingNumber: val }),
            });
          } catch {}

          if (!email) return;

          const subject = 'Your LM3DPTFY order has shipped — Tracking #' + ' ' + val;
          const body =
            'Hi ' + name + ',\n\n' +
            'Great news — your print has shipped!\n\n' +
            'Tracking number: ' + val + '\n\n' +
            (stlLink ? ('Your model link: ' + stlLink + '\n\n') : '') +
            'Thanks again!\n' +
            '— LM3DPTFY';

          window.open(buildGmailUrl(email, subject, body), '_blank');
        }, 10);
      });

      trackingRow.appendChild(trackingLab);
      trackingRow.appendChild(trackingInput);

      rightKv.appendChild(statusRow);
      rightKv.appendChild(fulfillRow);
      rightKv.appendChild(trackingRow);
      right.appendChild(rightKv);

      body.appendChild(left);
      body.appendChild(right);

      wrap.appendChild(top);
      wrap.appendChild(body);

      return wrap;
    }

    // =========================
    // LOAD REQUESTS
    // =========================
    async function loadRequests(){
      try{
        // load settings first so source detection + fulfilled list is accurate
        await loadSettings();

        const res = await fetch('/api/requests', { credentials:'include' });
        if (res.status === 401){
          loginCard.style.display = 'block';
          dashboardCard.style.display = 'none';
          return;
        }

        const data = await res.json();
        const active = data.filter(r => !r.archived);
        const archived = data.filter(r => r.archived);

        activeList.innerHTML = '';
        archivedList.innerHTML = '';

        if (!active.length){
          const empty = document.createElement('div');
          empty.style.color = 'var(--muted)';
          empty.style.padding = '10px 2px';
          empty.textContent = 'No active requests.';
          activeList.appendChild(empty);
        } else {
          active.forEach(r => activeList.appendChild(renderOrderCard(r)));
        }

        if (!archived.length){
          const empty = document.createElement('div');
          empty.style.color = 'var(--muted)';
          empty.style.padding = '10px 2px';
          empty.textContent = 'No archived requests.';
          archivedList.appendChild(empty);
        } else {
          archived.forEach(r => archivedList.appendChild(renderOrderCard(r)));
        }

        loginCard.style.display = 'none';
        dashboardCard.style.display = 'block';
        showDashStatus('Loaded ' + data.length + ' request(s).', false);
      } catch(err){
        console.error(err);
        showDashStatus('Error loading requests: ' + err.message, true);
      }
    }

    // =========================
    // AUTH
    // =========================
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginStatus.style.display = 'block';
      loginStatus.textContent = 'Signing in...';
      loginStatus.classList.remove('status-error', 'status-success');

      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;

      try{
        const res = await fetch('/api/login', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Invalid email or password');

        loginStatus.textContent = 'Login successful. Loading dashboard...';
        loginStatus.classList.add('status-success');

        await loadRequests();
      } catch(err){
        loginStatus.textContent = err.message;
        loginStatus.classList.add('status-error');
      }
    });

    async function doLogout(){
      try{ await fetch('/api/logout', { method:'POST', credentials:'include' }); } catch(e){}
      loginCard.style.display = 'block';
      dashboardCard.style.display = 'none';
      loginForm.reset();
    }
    logoutTopBtn.addEventListener('click', doLogout);

    // =========================
    // SHEETS ACTIONS
    // =========================
    reloadBtn?.addEventListener('click', async () => {
      showDashStatus('Refreshing from Google Sheets...', false);
      try{
        const res = await fetch('/api/sheets/reload', { method:'POST', credentials:'include' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Reload failed');
        showDashStatus('Reloaded ' + (data.count || 0) + ' requests from Sheets.', false);
        await loadRequests();
      } catch(err){
        showDashStatus('Reload failed: ' + err.message, true);
      }
    });

    syncBtn?.addEventListener('click', async () => {
      showDashStatus('Syncing to Google Sheets...', false);
      try{
        const res = await fetch('/api/sheets/sync', { method:'POST', credentials:'include' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Sync failed');
        showDashStatus('Synced ' + (data.count || 0) + ' requests to Sheets.', false);
      } catch(err){
        showDashStatus('Sync failed: ' + err.message, true);
      }
    });

    // Load on page open
    loadRequests();
  </script>
</body>
</html>
