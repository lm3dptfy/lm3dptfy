<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin | LM3DPTFY Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="page-shell">
    <main class="page-main">
      <div class="main-inner admin-main-inner">
        <!-- Login card -->
        <div id="loginCard" class="admin-card">
          <div class="top-util-bar">
            <a href="/" class="logo-link">
              <img
                src="lm3dptfy-logo-tp-cropped.png"
                alt="LM3DPTFY.online - Let Me 3D Print That For You"
                class="main-logo"
              />
            </a>
            <div class="brand-mark">ADMIN</div>
          </div>
          <h1 class="admin-header-text">Admin login</h1>
          <p class="admin-subtitle">Sign in to see and manage quote requests.</p>

          <form id="loginForm" class="stl-form">
            <div class="field-group">
              <label for="adminEmail" class="field-label">Admin email</label>
              <input type="email" id="adminEmail" class="field-input" required />
            </div>
            <div class="field-group">
              <label for="adminPassword" class="field-label">Password</label>
              <input type="password" id="adminPassword" class="field-input" required />
            </div>
            <button type="submit" class="btn-primary">Log in</button>
            <p id="loginStatus" class="status-message"></p>
          </form>
        </div>

        <!-- Dashboard card -->
        <div id="dashboardCard" class="admin-card" style="display:none;">
          <div class="top-util-bar">
            <a href="/" class="logo-link">
              <img
                src="lm3dptfy-logo-tp-cropped.png"
                alt="LM3DPTFY.online - Let Me 3D Print That For You"
                class="main-logo"
              />
            </a>
            <button id="logoutBtn" class="link-btn logout-btn">Log out</button>
          </div>

          <h1 class="admin-header-text">Quote requests</h1>
          <p class="admin-subtitle">Active and archived requests from lm3dptfy.online.</p>

          <div class="table-wrapper">
            <h2 class="info-title">Active</h2>
            <table class="request-table">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>STL link</th>
                  <th>Notes</th>
                  <th>Status</th>
                  <th>Reply</th>
                  <th>Archive</th>
                </tr>
              </thead>
              <tbody id="activeBody">
                <!-- filled by JS -->
              </tbody>
            </table>
          </div>

          <div class="table-wrapper" style="margin-top:16px;">
            <h2 class="info-title">Archived</h2>
            <table class="request-table">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>STL link</th>
                  <th>Notes</th>
                  <th>Status</th>
                  <th>Reply</th>
                  <th>Archive</th>
                </tr>
              </thead>
              <tbody id="archivedBody">
                <!-- filled by JS -->
              </tbody>
            </table>
          </div>

          <p id="dashboardStatus" class="status-message"></p>
        </div>
      </div>
    </main>

    <footer class="site-footer">
      LM3DPTFY Admin · Keep this page private.
    </footer>
  </div>

  <script>
    const loginForm = document.getElementById('loginForm');
    const loginStatus = document.getElementById('loginStatus');
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const activeBody = document.getElementById('activeBody');
    const archivedBody = document.getElementById('archivedBody');
    const dashboardStatus = document.getElementById('dashboardStatus');
    const logoutBtn = document.getElementById('logoutBtn');

    const STATUS_OPTIONS = [
      { value: 'new', label: 'New' },
      { value: 'responded', label: 'Responded' },
      { value: 'quote_approved', label: 'Quote approved' },
      { value: 'sent_to_printer', label: 'Sent to printer' },
      { value: 'print_complete', label: 'Print complete' },
      { value: 'qc_complete', label: 'QC complete' },
      { value: 'shipped', label: 'Shipped' },
      { value: 'paid', label: 'Paid' },
    ];

    const GMAIL_AUTH_USER = 'lm3dptfy@gmail.com';

    function buildGmailUrl(toEmail, subject, bodyLines) {
      let url = 'https://mail.google.com/mail/?view=cm&fs=1&tf=1';
      url += '&authuser=' + encodeURIComponent(GMAIL_AUTH_USER);
      url += '&to=' + encodeURIComponent(toEmail);
      url += '&su=' + encodeURIComponent(subject);
      url += '&body=' + encodeURIComponent(bodyLines.join('\\n'));
      return url;
    }

    function safeText(text) {
      return (text || '').replace(/&/g, '&amp;').replace(/</g, '&lt;');
    }

    function buildRow(r) {
      const tr = document.createElement('tr');
      const safeDetails = safeText(r.details || '');

      tr.innerHTML = `
        <td>${new Date(r.createdAt).toLocaleString()}</td>
        <td>${safeText(r.name || '')}</td>
        <td><a href="mailto:${safeText(r.email)}">${safeText(r.email)}</a></td>
        <td><a href="${safeText(r.stlLink)}" target="_blank">View STL</a></td>
        <td>${safeDetails}</td>
        <td class="status-cell"></td>
        <td>
          <button
            class="link-btn reply-gmail-btn"
            data-id="${r.id}"
            data-email="${safeText(r.email)}"
            data-name="${safeText(r.name || '')}"
            data-link="${safeText(r.stlLink)}"
          >
            Reply
          </button>
        </td>
        <td>
          <input
            type="checkbox"
            class="archive-checkbox"
            data-id="${r.id}"
            ${r.archived ? 'checked' : ''}
          />
        </td>
      `;

      const statusCell = tr.querySelector('.status-cell');
      const select = document.createElement('select');
      select.className = 'status-select';
      select.dataset.id = r.id;
      STATUS_OPTIONS.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        if ((r.status || 'new') === opt.value) {
          option.selected = true;
        }
        select.appendChild(option);
      });
      statusCell.appendChild(select);

      return tr;
    }

    async function loadRequests() {
      dashboardStatus.textContent = 'Loading requests...';
      try {
        const res = await fetch('/api/requests');
        if (res.status === 401) {
          loginCard.style.display = 'block';
          dashboardCard.style.display = 'none';
          logoutBtn.style.display = 'none';
          return;
        }
        const data = await res.json();

        const active = data.filter(r => !r.archived);
        const archived = data.filter(r => r.archived);

        activeBody.innerHTML = '';
        archivedBody.innerHTML = '';

        if (active.length === 0) {
          activeBody.innerHTML = '<tr><td colspan="8">No active requests.</td></tr>';
        } else {
          active.forEach(r => {
            activeBody.appendChild(buildRow(r));
          });
        }

        if (archived.length === 0) {
          archivedBody.innerHTML = '<tr><td colspan="8">No archived requests.</td></tr>';
        } else {
          archived.forEach(r => {
            archivedBody.appendChild(buildRow(r));
          });
        }

        dashboardStatus.textContent = '';
      } catch (err) {
        dashboardStatus.textContent = 'Error loading requests.';
      }
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginStatus.textContent = 'Logging in...';
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (!res.ok) {
          loginStatus.textContent = 'Invalid credentials.';
          return;
        }

        loginStatus.textContent = '';
        loginCard.style.display = 'none';
        dashboardCard.style.display = 'block';
        logoutBtn.style.display = 'inline-block';
        loadRequests();
      } catch (err) {
        loginStatus.textContent = 'Login error, try again.';
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST' });
      loginCard.style.display = 'block';
      dashboardCard.style.display = 'none';
      logoutBtn.style.display = 'none';
    });

    function handleStatusChange(e) {
      const select = e.target.closest('.status-select');
      if (!select) return;
      const id = select.dataset.id;
      const status = select.value;

      dashboardStatus.textContent = 'Updating status...';
      dashboardStatus.classList.remove('status-success', 'status-error');

      fetch(`/api/requests/${id}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      })
        .then(res => res.json().then(data => ({ res, data })))
        .then(({ res, data }) => {
          if (!res.ok || !data.ok) {
            throw new Error(data.error || 'fail');
          }
          dashboardStatus.textContent = 'Status updated.';
          dashboardStatus.classList.add('status-success');
        })
        .catch(() => {
          dashboardStatus.textContent = 'Error updating status.';
          dashboardStatus.classList.add('status-error');
        });
    }

    function handleArchiveToggle(e) {
      const checkbox = e.target.closest('.archive-checkbox');
      if (!checkbox) return;
      const id = checkbox.dataset.id;
      const archived = checkbox.checked;

      dashboardStatus.textContent = archived ? 'Archiving...' : 'Unarchiving...';
      dashboardStatus.classList.remove('status-success', 'status-error');

      fetch(`/api/requests/${id}/archive`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ archived })
      })
        .then(res => res.json().then(data => ({ res, data })))
        .then(({ res, data }) => {
          if (!res.ok || !data.ok) {
            throw new Error(data.error || 'fail');
          }
          dashboardStatus.textContent = archived ? 'Moved to archived.' : 'Moved to active.';
          dashboardStatus.classList.add('status-success');
          loadRequests();
        })
        .catch(() => {
          dashboardStatus.textContent = 'Error updating archive state.';
          dashboardStatus.classList.add('status-error');
        });
    }

    function handleReplyClick(e) {
      const btn = e.target.closest('.reply-gmail-btn');
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      const email = btn.getAttribute('data-email');
      const name = btn.getAttribute('data-name') || '';
      const link = btn.getAttribute('data-link') || '';

      const subject = '3D printing quote from LM3DPTFY';
      const bodyLines = [
        name ? `Hi ${name},` : 'Hi,',
        '',
        'Here is your 3D printing quote:',
        '',
        link ? `STLFlix link: ${link}` : '',
        '',
        'Reply here with any questions or to approve the quote.',
        '',
        'Thank you,',
        'LM3DPTFY'
      ].filter(Boolean);

      const gmailUrl = buildGmailUrl(email, subject, bodyLines);
      window.open(gmailUrl, '_blank');

      dashboardStatus.textContent = 'Opening Gmail…';
      dashboardStatus.classList.remove('status-success', 'status-error');

      fetch(`/api/requests/${id}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'responded' })
      })
        .then(res => res.json().then(data => ({ res, data })))
        .then(({ res, data }) => {
          if (!res.ok || !data.ok) {
            throw new Error(data.error || 'fail');
          }
          dashboardStatus.textContent = 'Status set to "Responded".';
          dashboardStatus.classList.add('status-success');
          loadRequests();
        })
        .catch(() => {
          dashboardStatus.textContent = 'Error updating status after reply.';
          dashboardStatus.classList.add('status-error');
        });
    }

    activeBody.addEventListener('change', handleStatusChange);
    archivedBody.addEventListener('change', handleStatusChange);
    activeBody.addEventListener('change', handleArchiveToggle);
    archivedBody.addEventListener('change', handleArchiveToggle);
    activeBody.addEventListener('click', handleReplyClick);
    archivedBody.addEventListener('click', handleReplyClick);

    loadRequests();
  </script>
</body>
</html>
