<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin | LM3DPTFY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />

  <style>
    .admin-wrap{ display:flex; flex-direction:column; gap:16px; }
    .admin-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;
    }
    .admin-title{ margin:0; font-size:1.5rem; letter-spacing:-.02em; }
    .admin-subtitle{ margin:6px 0 0; color:var(--muted); }
    .admin-actions{ display:flex; gap:10px; flex-wrap:wrap; }

    .settings-card{ padding:16px; }
    .settings-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 12px;
    }
    @media (max-width: 860px){
      .settings-grid{ grid-template-columns: 1fr; }
    }
    .settings-box{
      border:1px solid var(--border);
      border-radius: var(--radiusLG);
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.70));
      box-shadow: var(--shadowSoft);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .settings-box h3{ margin:0; font-size:1rem; }
    .settings-box p{ margin:0; color:var(--muted); font-size:.92rem; line-height:1.4; }
    .settings-row{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .settings-list{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .tag{
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      font-size:.85rem;
      color: rgba(15,23,42,.85);
      font-weight: 650;
    }

    .section-title{ margin:0 0 10px; }
    .orders{ display:flex; flex-direction:column; gap:12px; }
    .order{
      border-radius: var(--radiusXL);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadowSoft);
      padding: 14px;
    }
    .order-top{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap: 12px; flex-wrap:wrap;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(15,23,42,.06);
      margin-bottom: 12px;
    }
    .order-meta{ min-width: 260px; }
    .order-created{ color: var(--muted); font-size:.88rem; }
    .order-name{ font-weight: 850; font-size: 1.05rem; margin-top: 2px; }
    .order-email a{ color: var(--accent); text-decoration:none; font-weight: 700; }
    .order-email a:hover{ text-decoration: underline; }
    .order-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .order-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 860px){
      .order-grid{ grid-template-columns: 1fr; }
    }

    .box{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.75);
      padding: 12px;
    }
    .mini-label{
      font-size:.78rem;
      font-weight:800;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(100,116,139,.95);
      margin:0 0 8px;
    }
    .box p{ margin:0; color: rgba(15,23,42,.90); line-height:1.45; }

    .controls{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 860px){
      .controls{ grid-template-columns: 1fr; }
    }

    .toggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      color: var(--muted);
      font-size:.85rem;
      font-weight: 650;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background: rgba(2,6,23,.55);
      display:none; align-items:center; justify-content:center;
      z-index: 999;
      padding: 18px;
    }
    .modal{
      width: min(860px, 100%);
      background: #fff;
      border-radius: var(--radiusXL);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 30px 90px rgba(2,6,23,.55);
      overflow:hidden;
    }
    .modal-head{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background: rgba(246,248,252,.9);
    }
    .modal-head h2{ margin:0; font-size: 1.05rem; }
    .modal-head p{ margin:6px 0 0; color: var(--muted); font-size:.9rem; }
    .modal-body{ padding: 16px; display:flex; flex-direction:column; gap:12px; }
    .modal-foot{
      padding: 14px 16px;
      border-top: 1px solid var(--border);
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
      background: rgba(246,248,252,.9);
    }
    .btn-ghost{
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      color: var(--muted);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      cursor:pointer;
    }
    .btn-ghost:hover{ background:#fff; }

    .row{
      display:grid;
      grid-template-columns: 1.2fr 1.2fr 1.8fr .8fr .4fr;
      gap:10px;
      align-items:center;
    }
    .row .field-input{ padding:10px 12px; border-radius: 12px; }
    .row small{ color: var(--muted); }
    @media (max-width: 860px){
      .row{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body class="admin-page">
  <div class="page-shell">
    <header class="topbar">
      <div class="topbar-inner">
        <a class="brand" href="/" title="Home">
          <img src="/lm3dptfy-logo-tp-cropped.png" alt="LM3DPTFY logo" />
          <div class="brand-title">
            <strong>Let Me 3D Print That For You</strong>
            <span>Admin dashboard • Private</span>
          </div>
        </a>

        <div class="nav-right">
          <a class="pill-link" href="/">Home</a>
          <button id="logoutTopBtn" class="pill-link" type="button">Log out</button>
        </div>
      </div>
    </header>

    <main class="page-main">
      <div class="main-inner">

        <!-- Login -->
        <div id="loginCard" class="card" style="max-width:560px;margin:0 auto;padding:18px;">
          <h1 class="admin-title" style="font-size:1.25rem;margin:0 0 6px;">Admin login</h1>
          <p class="admin-subtitle" style="margin:0 0 14px;">Sign in to see and manage quote requests.</p>

          <form id="loginForm" class="stl-form">
            <div>
              <label for="adminEmail" class="field-label">Admin email</label>
              <input type="email" id="adminEmail" class="field-input" required />
            </div>
            <div>
              <label for="adminPassword" class="field-label">Password</label>
              <input type="password" id="adminPassword" class="field-input" required />
            </div>
            <button type="submit" class="btn-primary">Log in</button>
            <p id="loginStatus" class="status-message" style="display:none;"></p>
          </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboardCard" style="display:none;">
          <div class="admin-wrap">

            <div class="admin-head">
              <div>
                <h1 class="admin-title">Quote requests</h1>
                <p class="admin-subtitle">Active + archived requests from lm3dptfy.online.</p>
              </div>

              <div class="admin-actions">
                <button id="reloadSheetsBtn" class="btn-primary btn-sm" type="button">Refresh from Sheets</button>
                <button id="syncSheetsBtn" class="btn-primary btn-sm" type="button">Sync to Sheets</button>
                <a href="/api/export/csv" class="btn-primary btn-sm" style="text-decoration:none;">Export CSV</a>
                <a href="/api/export/json" class="btn-primary btn-sm" style="text-decoration:none;">Export JSON</a>
              </div>
            </div>

            <p id="dashboardStatus" class="status-message" style="display:none;"></p>

            <!-- Settings -->
            <section class="card settings-card">
              <h2 class="section-title" style="margin:0;">Settings</h2>

              <div class="settings-grid">
                <div class="settings-box">
                  <div class="settings-row">
                    <div>
                      <h3 style="margin:0;">Fulfilled by list</h3>
                      <p style="margin-top:6px;">These names appear in the “Fulfilled by” dropdown on each order.</p>
                    </div>
                    <button id="editFulfillersBtn" class="btn-primary btn-sm" type="button">Edit</button>
                  </div>
                  <div class="settings-list" id="fulfillersPreview"></div>
                </div>

                <div class="settings-box">
                  <div class="settings-row">
                    <div>
                      <h3 style="margin:0;">Supported sites</h3>
                      <p style="margin-top:6px;">These sites appear on the Home page as options and power source detection on the Request page.</p>
                    </div>
                    <button id="editSitesBtn" class="btn-primary btn-sm" type="button">Edit</button>
                  </div>
                  <div class="settings-list" id="sitesPreview"></div>
                </div>
              </div>
            </section>

            <!-- Active -->
            <section class="card" style="padding:16px;">
              <h2 class="section-title" style="margin:0 0 10px;">Active</h2>
              <div class="orders" id="activeList"></div>
              <p class="tip" style="margin-top:12px;color:var(--muted);font-size:.9rem;">
                Tip: Set status to <strong>Shipped</strong> to enable Tracking #. When you paste tracking, an email draft can open automatically.
              </p>
            </section>

            <!-- Archived -->
            <section class="card" style="padding:16px;">
              <h2 class="section-title" style="margin:0 0 10px;">Archived</h2>
              <div class="orders" id="archivedList"></div>
              <p class="tip" style="margin-top:12px;color:var(--muted);font-size:.9rem;">
                Tip: Bookmark <strong>/admin</strong>. This page is meant to stay private.
              </p>
            </section>

          </div>
        </div>

      </div>
    </main>

    <footer class="site-footer">
      LM3DPTFY Admin · Keep this page private.
    </footer>
  </div>

  <!-- Fulfillers Modal -->
  <div class="modal-backdrop" id="fulfillersModal">
    <div class="modal">
      <div class="modal-head">
        <div>
          <h2>Edit “Fulfilled by” names</h2>
          <p>Add/remove names used in the Fulfilled By dropdown.</p>
        </div>
        <button class="btn-ghost" type="button" data-close="fulfillersModal">Close</button>
      </div>
      <div class="modal-body" id="fulfillersBody"></div>
      <div class="modal-foot">
        <button class="btn-ghost" type="button" id="addFulfillerRowBtn">+ Add name</button>
        <button class="btn-primary" type="button" id="saveFulfillersBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Sites Modal -->
  <div class="modal-backdrop" id="sitesModal">
    <div class="modal">
      <div class="modal-head">
        <div>
          <h2>Edit supported sites</h2>
          <p>These enabled sites show on the Home page and power source detection.</p>
        </div>
        <button class="btn-ghost" type="button" data-close="sitesModal">Close</button>
      </div>
      <div class="modal-body" id="sitesBody"></div>
      <div class="modal-foot">
        <button class="btn-ghost" type="button" id="addSiteRowBtn">+ Add site</button>
        <button class="btn-primary" type="button" id="saveSitesBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    const loginForm = document.getElementById('loginForm');
    const loginStatus = document.getElementById('loginStatus');
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const dashboardStatus = document.getElementById('dashboardStatus');

    const activeList = document.getElementById('activeList');
    const archivedList = document.getElementById('archivedList');

    const reloadBtn = document.getElementById('reloadSheetsBtn');
    const syncBtn = document.getElementById('syncSheetsBtn');
    const logoutTopBtn = document.getElementById('logoutTopBtn');

    const editFulfillersBtn = document.getElementById('editFulfillersBtn');
    const editSitesBtn = document.getElementById('editSitesBtn');
    const fulfillersPreview = document.getElementById('fulfillersPreview');
    const sitesPreview = document.getElementById('sitesPreview');

    const fulfillersModal = document.getElementById('fulfillersModal');
    const sitesModal = document.getElementById('sitesModal');
    const fulfillersBody = document.getElementById('fulfillersBody');
    const sitesBody = document.getElementById('sitesBody');
    const addFulfillerRowBtn = document.getElementById('addFulfillerRowBtn');
    const saveFulfillersBtn = document.getElementById('saveFulfillersBtn');
    const addSiteRowBtn = document.getElementById('addSiteRowBtn');
    const saveSitesBtn = document.getElementById('saveSitesBtn');

    const STATUS_OPTIONS = [
      { value: 'new', label: 'New' },
      { value: 'responded', label: 'Responded' },
      { value: 'quote_approved', label: 'Quote approved' },
      { value: 'sent_to_printer', label: 'Sent to printer' },
      { value: 'print_complete', label: 'Print complete' },
      { value: 'qc_complete', label: 'QC complete' },
      { value: 'shipped', label: 'Shipped' },
      { value: 'paid', label: 'Paid' }
    ];

    const GMAIL_AUTH_USER = 'lm3dptfy@gmail.com';

    let SETTINGS = { fulfilledByNames: [], supportedSites: [] };
    let REQUESTS = [];

    function showDashStatus(msg, isError) {
      dashboardStatus.textContent = msg;
      dashboardStatus.style.display = 'block';
      dashboardStatus.classList.toggle('status-error', !!isError);
      dashboardStatus.classList.toggle('status-success', !isError);
      if (!isError) setTimeout(() => { dashboardStatus.style.display = 'none'; }, 4500);
    }

    function buildGmailUrl(toEmail, subject, body) {
      let url = 'https://mail.google.com/mail/?view=cm&fs=1&tf=1';
      url += '&authuser=' + encodeURIComponent(GMAIL_AUTH_USER);
      url += '&to=' + encodeURIComponent(toEmail);
      url += '&su=' + encodeURIComponent(subject);
      url += '&body=' + encodeURIComponent(body);
      return url;
    }

    function openModal(id) {
      document.getElementById(id).style.display = 'flex';
    }
    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    document.addEventListener('click', (e) => {
      const closeId = e.target && e.target.getAttribute && e.target.getAttribute('data-close');
      if (closeId) closeModal(closeId);
      if (e.target === fulfillersModal) closeModal('fulfillersModal');
      if (e.target === sitesModal) closeModal('sitesModal');
    });

    function normalizeHost(host) {
      return String(host || '').trim().toLowerCase().replace(/^www\./, '');
    }

    function renderSettingsPreviews() {
      fulfillersPreview.innerHTML = '';
      (SETTINGS.fulfilledByNames || []).forEach(n => {
        const t = document.createElement('span');
        t.className = 'tag';
        t.textContent = n;
        fulfillersPreview.appendChild(t);
      });

      sitesPreview.innerHTML = '';
      (SETTINGS.supportedSites || []).forEach(s => {
        const t = document.createElement('span');
        t.className = 'tag';
        t.textContent = `${s.enabled ? '✅' : '⛔'} ${s.name}`;
        sitesPreview.appendChild(t);
      });
    }

    function renderFulfillersModal() {
      fulfillersBody.innerHTML = '';
      const names = Array.isArray(SETTINGS.fulfilledByNames) ? SETTINGS.fulfilledByNames : [];

      names.forEach((name, idx) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '10px';
        row.style.alignItems = 'center';

        const input = document.createElement('input');
        input.className = 'field-input';
        input.value = name;
        input.placeholder = 'Name';
        input.setAttribute('data-idx', String(idx));
        input.style.flex = '1';

        const del = document.createElement('button');
        del.className = 'btn-ghost';
        del.type = 'button';
        del.textContent = 'Remove';
        del.onclick = () => {
          SETTINGS.fulfilledByNames.splice(idx, 1);
          renderFulfillersModal();
        };

        row.appendChild(input);
        row.appendChild(del);
        fulfillersBody.appendChild(row);
      });

      if (!names.length) {
        const p = document.createElement('p');
        p.style.color = 'var(--muted)';
        p.style.margin = '0';
        p.textContent = 'No names yet — add at least one.';
        fulfillersBody.appendChild(p);
      }
    }

    function renderSitesModal() {
      sitesBody.innerHTML = '';
      const sites = Array.isArray(SETTINGS.supportedSites) ? SETTINGS.supportedSites : [];

      sites.forEach((s, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'box';

        const grid = document.createElement('div');
        grid.className = 'row';

        const name = document.createElement('input');
        name.className = 'field-input';
        name.placeholder = 'Site name (e.g., STLFlix)';
        name.value = s.name || '';
        name.setAttribute('data-idx', idx);
        name.setAttribute('data-field', 'name');

        const hosts = document.createElement('input');
        hosts.className = 'field-input';
        hosts.placeholder = 'Domains (comma separated) e.g. stlflix.com, platform.stlflix.com';
        hosts.value = (Array.isArray(s.hosts) ? s.hosts : []).join(', ');
        hosts.setAttribute('data-idx', idx);
        hosts.setAttribute('data-field', 'hosts');

        const browse = document.createElement('input');
        browse.className = 'field-input';
        browse.placeholder = 'Browse URL (optional)';
        browse.value = s.browseUrl || '';
        browse.setAttribute('data-idx', idx);
        browse.setAttribute('data-field', 'browseUrl');

        const enabledWrap = document.createElement('label');
        enabledWrap.className = 'toggle';
        enabledWrap.style.justifyContent = 'center';
        enabledWrap.style.width = 'fit-content';
        const enabled = document.createElement('input');
        enabled.type = 'checkbox';
        enabled.checked = !!s.enabled;
        enabled.setAttribute('data-idx', idx);
        enabled.setAttribute('data-field', 'enabled');
        enabledWrap.appendChild(enabled);
        enabledWrap.appendChild(document.createTextNode(' Enabled'));

        const del = document.createElement('button');
        del.className = 'btn-ghost';
        del.type = 'button';
        del.textContent = 'Remove';
        del.onclick = () => {
          SETTINGS.supportedSites.splice(idx, 1);
          renderSitesModal();
        };

        grid.appendChild(name);
        grid.appendChild(hosts);
        grid.appendChild(browse);
        grid.appendChild(enabledWrap);
        grid.appendChild(del);

        const note = document.createElement('small');
        note.textContent = 'Tip: Domains power detection. Enabled sites appear on the Home page.';
        wrap.appendChild(grid);
        wrap.appendChild(note);

        sitesBody.appendChild(wrap);
      });

      if (!sites.length) {
        const p = document.createElement('p');
        p.style.color = 'var(--muted)';
        p.style.margin = '0';
        p.textContent = 'No sites yet — add at least one.';
        sitesBody.appendChild(p);
      }
    }

    function detectSourceName(stlLink) {
      if (!stlLink) return 'Unknown';
      let u;
      try { u = new URL(stlLink); } catch { return 'Unknown'; }
      const host = normalizeHost(u.hostname);

      const allSites = Array.isArray(SETTINGS.supportedSites) ? SETTINGS.supportedSites : [];
      for (const s of allSites) {
        const hosts = Array.isArray(s.hosts) ? s.hosts.map(normalizeHost) : [];
        if (hosts.includes(host)) return s.name || 'Unknown';
        for (const h of hosts) {
          if (h && host.endsWith('.' + h)) return s.name || 'Unknown';
        }
      }
      return 'Unknown';
    }

    function renderOrders() {
      const active = REQUESTS.filter(r => !r.archived);
      const archived = REQUESTS.filter(r => r.archived);

      activeList.innerHTML = '';
      archivedList.innerHTML = '';

      if (!active.length) {
        const p = document.createElement('p');
        p.style.color = 'var(--muted)';
        p.style.margin = '0';
        p.textContent = 'No active requests.';
        activeList.appendChild(p);
      } else {
        active.forEach(r => activeList.appendChild(renderOrderCard(r)));
      }

      if (!archived.length) {
        const p = document.createElement('p');
        p.style.color = 'var(--muted)';
        p.style.margin = '0';
        p.textContent = 'No archived requests.';
        archivedList.appendChild(p);
      } else {
        archived.forEach(r => archivedList.appendChild(renderOrderCard(r)));
      }
    }

    function renderOrderCard(r) {
      const card = document.createElement('div');
      card.className = 'order';

      const created = r.createdAt ? new Date(r.createdAt).toLocaleString() : '';
      const sourceName = detectSourceName(r.stlLink);

      const top = document.createElement('div');
      top.className = 'order-top';

      const meta = document.createElement('div');
      meta.className = 'order-meta';

      const createdEl = document.createElement('div');
      createdEl.className = 'order-created';
      createdEl.textContent = created;

      const nameEl = document.createElement('div');
      nameEl.className = 'order-name';
      nameEl.textContent = r.name || '';

      const emailEl = document.createElement('div');
      emailEl.className = 'order-email';
      if (r.email) {
        const a = document.createElement('a');
        a.href = 'mailto:' + r.email;
        a.textContent = r.email;
        emailEl.appendChild(a);
      }

      const sourceTag = document.createElement('div');
      sourceTag.style.marginTop = '6px';
      const t = document.createElement('span');
      t.className = 'tag';
      t.textContent = `Source: ${sourceName}`;
      sourceTag.appendChild(t);

      meta.appendChild(createdEl);
      meta.appendChild(nameEl);
      meta.appendChild(emailEl);
      meta.appendChild(sourceTag);

      const actions = document.createElement('div');
      actions.className = 'order-actions';

      if (r.stlLink) {
        const view = document.createElement('a');
        view.className = 'pill-link';
        view.href = r.stlLink;
        view.target = '_blank';
        view.rel = 'noopener noreferrer';
        view.textContent = 'View model';
        actions.appendChild(view);
      }

      const replyBtn = document.createElement('a');
      replyBtn.className = 'btn-primary btn-sm';
      replyBtn.style.textDecoration = 'none';
      replyBtn.textContent = 'Reply';
      replyBtn.href = buildGmailUrl(
        r.email || '',
        'LM3DPTFY Quote / Update',
        `Hi ${r.name || ''},\n\nThanks for your request! Here’s the next step:\n\nModel link: ${r.stlLink || ''}\nStatus: ${r.status || 'new'}\n\n(Reply here with your quote/ETA/questions.)\n\n- LM3DPTFY`
      );
      replyBtn.target = '_blank';
      replyBtn.rel = 'noopener noreferrer';
      actions.appendChild(replyBtn);

      const archiveLabel = document.createElement('label');
      archiveLabel.className = 'toggle';
      archiveLabel.title = 'Archive / unarchive';

      const archiveCb = document.createElement('input');
      archiveCb.type = 'checkbox';
      archiveCb.checked = !!r.archived;

      archiveCb.onchange = async () => {
        try {
          await apiPost(`/api/requests/${r.id}/archive`, { archived: archiveCb.checked });
          r.archived = archiveCb.checked;
          showDashStatus('Saved archive change.', false);
          renderOrders();
        } catch (e) {
          archiveCb.checked = !archiveCb.checked;
          showDashStatus(e.message || 'Failed to archive.', true);
        }
      };

      archiveLabel.appendChild(archiveCb);
      archiveLabel.appendChild(document.createTextNode(' Archive'));
      actions.appendChild(archiveLabel);

      top.appendChild(meta);
      top.appendChild(actions);

      const grid = document.createElement('div');
      grid.className = 'order-grid';

      const customerBox = document.createElement('div');
      customerBox.className = 'box';
      customerBox.innerHTML = `<div class="mini-label">Customer notes</div><p>${escapeHtml(r.details || '') || '<span style="color:var(--muted);">None</span>'}</p>`;

      const adminBox = document.createElement('div');
      adminBox.className = 'box';

      const adminLabel = document.createElement('div');
      adminLabel.className = 'mini-label';
      adminLabel.textContent = 'Admin notes';

      const adminNotes = document.createElement('textarea');
      adminNotes.className = 'field-input';
      adminNotes.rows = 3;
      adminNotes.value = r.adminNotes || '';
      adminNotes.placeholder = 'Internal notes…';

      let notesTimer = null;
      adminNotes.addEventListener('input', () => {
        clearTimeout(notesTimer);
        notesTimer = setTimeout(async () => {
          try {
            await apiPost(`/api/requests/${r.id}/admin-notes`, { adminNotes: adminNotes.value });
            r.adminNotes = adminNotes.value;
            showDashStatus('Saved admin notes.', false);
          } catch (e) {
            showDashStatus(e.message || 'Failed to save notes.', true);
          }
        }, 550);
      });

      adminBox.appendChild(adminLabel);
      adminBox.appendChild(adminNotes);

      grid.appendChild(customerBox);
      grid.appendChild(adminBox);

      const controls = document.createElement('div');
      controls.className = 'controls';

      // Status
      const statusWrap = document.createElement('div');
      statusWrap.innerHTML = `<div class="mini-label">Status</div>`;
      const statusSel = document.createElement('select');
      statusSel.className = 'field-input';
      STATUS_OPTIONS.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;
        if (r.status === o.value) opt.selected = true;
        statusSel.appendChild(opt);
      });

      statusSel.onchange = async () => {
        try {
          await apiPost(`/api/requests/${r.id}/status`, { status: statusSel.value });
          r.status = statusSel.value;
          showDashStatus('Saved status.', false);
          // enable/disable tracking
          trackingInput.disabled = !(r.status === 'shipped' || (r.trackingNumber || '').length > 0);
        } catch (e) {
          showDashStatus(e.message || 'Failed to save status.', true);
          statusSel.value = r.status;
        }
      };

      statusWrap.appendChild(statusSel);

      // Fulfilled by
      const fulfilledWrap = document.createElement('div');
      fulfilledWrap.innerHTML = `<div class="mini-label">Fulfilled by</div>`;
      const fulfilledSel = document.createElement('select');
      fulfilledSel.className = 'field-input';

      const noneOpt = document.createElement('option');
      noneOpt.value = '';
      noneOpt.textContent = '-- None --';
      fulfilledSel.appendChild(noneOpt);

      (SETTINGS.fulfilledByNames || []).forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        if ((r.fulfilledBy || '') === n) opt.selected = true;
        fulfilledSel.appendChild(opt);
      });

      fulfilledSel.onchange = async () => {
        try {
          await apiPost(`/api/requests/${r.id}/fulfilled`, { fulfilledBy: fulfilledSel.value });
          r.fulfilledBy = fulfilledSel.value;
          showDashStatus('Saved fulfilled by.', false);
        } catch (e) {
          showDashStatus(e.message || 'Failed to save fulfilled by.', true);
          fulfilledSel.value = r.fulfilledBy || '';
        }
      };

      fulfilledWrap.appendChild(fulfilledSel);

      // Tracking #
      const trackingWrap = document.createElement('div');
      trackingWrap.innerHTML = `<div class="mini-label">Tracking #</div>`;
      const trackingInput = document.createElement('input');
      trackingInput.className = 'field-input';
      trackingInput.type = 'text';
      trackingInput.placeholder = (r.status === 'shipped') ? 'Paste tracking number' : 'Set status to Shipped';
      trackingInput.value = r.trackingNumber || '';
      trackingInput.disabled = !(r.status === 'shipped' || (r.trackingNumber || '').length > 0);

      let trackingTimer = null;
      trackingInput.addEventListener('input', () => {
        clearTimeout(trackingTimer);
        trackingTimer = setTimeout(async () => {
          try {
            await apiPost(`/api/requests/${r.id}/tracking`, { trackingNumber: trackingInput.value });
            const before = r.trackingNumber || '';
            r.trackingNumber = trackingInput.value;

            showDashStatus('Saved tracking #.', false);

            // Optional: auto-open email draft when tracking is first added and shipped
            if (r.status === 'shipped' && !before && (trackingInput.value || '').trim()) {
              const subject = 'Your order has shipped — Tracking included';
              const body = `Hi ${r.name || ''},\n\nYour order has shipped!\n\nTracking #: ${trackingInput.value.trim()}\n\nThanks!\n- LM3DPTFY`;
              window.open(buildGmailUrl(r.email || '', subject, body), '_blank', 'noopener,noreferrer');
            }
          } catch (e) {
            showDashStatus(e.message || 'Failed to save tracking.', true);
          }
        }, 650);
      });

      trackingWrap.appendChild(trackingInput);

      controls.appendChild(statusWrap);
      controls.appendChild(fulfilledWrap);
      controls.appendChild(trackingWrap);

      card.appendChild(top);
      card.appendChild(grid);
      card.appendChild(controls);

      return card;
    }

    function escapeHtml(s) {
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/\n/g, '<br/>');
    }

    async function apiPost(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body || {})
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || 'Request failed');
      return data;
    }

    async function apiPut(url, body) {
      const res = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body || {})
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || 'Request failed');
      return data;
    }

    async function apiGet(url) {
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }, credentials: 'include' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || 'Request failed');
      return data;
    }

    async function loadAll() {
      const s = await apiGet('/api/settings');
      SETTINGS = s.settings || SETTINGS;
      renderSettingsPreviews();

      REQUESTS = await apiGet('/api/requests');
      renderOrders();
    }

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginStatus.style.display = 'none';

      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Login failed');

        loginCard.style.display = 'none';
        dashboardCard.style.display = 'block';
        await loadAll();
      } catch (err) {
        loginStatus.style.display = 'block';
        loginStatus.textContent = '✗ ' + (err.message || 'Login failed');
        loginStatus.className = 'status-message status-error';
      }
    });

    // Attempt to load if already logged in (session cookie)
    (async () => {
      try {
        REQUESTS = await apiGet('/api/requests');
        loginCard.style.display = 'none';
        dashboardCard.style.display = 'block';
        const s = await apiGet('/api/settings');
        SETTINGS = s.settings || SETTINGS;
        renderSettingsPreviews();
        renderOrders();
      } catch {
        // not logged in
      }
    })();

    // Logout
    logoutTopBtn.addEventListener('click', async () => {
      try {
        await apiPost('/api/logout', {});
      } catch {}
      window.location.reload();
    });

    // Sheets actions
    reloadBtn.addEventListener('click', async () => {
      try {
        await apiPost('/api/sheets/reload', {});
        REQUESTS = await apiGet('/api/requests');
        renderOrders();
        showDashStatus('Reloaded from Sheets.', false);
      } catch (e) {
        showDashStatus(e.message || 'Failed to reload from Sheets.', true);
      }
    });

    syncBtn.addEventListener('click', async () => {
      try {
        await apiPost('/api/sheets/sync', {});
        showDashStatus('Synced to Sheets.', false);
      } catch (e) {
        showDashStatus(e.message || 'Failed to sync to Sheets.', true);
      }
    });

    // Settings: fulfillers modal
    editFulfillersBtn.addEventListener('click', () => {
      renderFulfillersModal();
      openModal('fulfillersModal');
    });

    addFulfillerRowBtn.addEventListener('click', () => {
      if (!Array.isArray(SETTINGS.fulfilledByNames)) SETTINGS.fulfilledByNames = [];
      SETTINGS.fulfilledByNames.push('');
      renderFulfillersModal();
    });

    saveFulfillersBtn.addEventListener('click', async () => {
      // pull inputs
      const inputs = fulfillersBody.querySelectorAll('input.field-input');
      const names = Array.from(inputs).map(i => (i.value || '').trim()).filter(Boolean);

      try {
        const resp = await apiPut('/api/settings/fulfillers', { names });
        SETTINGS.fulfilledByNames = resp.fulfilledByNames || names;
        renderSettingsPreviews();
        renderOrders();
        closeModal('fulfillersModal');
        showDashStatus('Saved fulfilled by list.', false);
      } catch (e) {
        showDashStatus(e.message || 'Failed to save fulfilled by list.', true);
      }
    });

    // Settings: sites modal
    editSitesBtn.addEventListener('click', () => {
      renderSitesModal();
      openModal('sitesModal');
    });

    addSiteRowBtn.addEventListener('click', () => {
      if (!Array.isArray(SETTINGS.supportedSites)) SETTINGS.supportedSites = [];
      SETTINGS.supportedSites.push({ name: '', hosts: [], browseUrl: '', enabled: true });
      renderSitesModal();
    });

    saveSitesBtn.addEventListener('click', async () => {
      const boxes = sitesBody.querySelectorAll('.box');
      const sites = [];

      boxes.forEach((box) => {
        const inputs = box.querySelectorAll('input.field-input');
        const enabled = box.querySelector('input[type="checkbox"]');

        const name = inputs[0]?.value?.trim() || '';
        const hostsRaw = inputs[1]?.value || '';
        const browseUrl = inputs[2]?.value?.trim() || '';

        const hosts = hostsRaw
          .split(/[\n,]+/)
          .map(x => normalizeHost(x))
          .filter(Boolean);

        if (!name) return;

        sites.push({
          name,
          hosts,
          browseUrl,
          enabled: !!(enabled && enabled.checked)
        });
      });

      try {
        const resp = await apiPut('/api/settings/sites', { sites });
        SETTINGS.supportedSites = resp.supportedSites || sites;
        renderSettingsPreviews();
        closeModal('sitesModal');
        showDashStatus('Saved supported sites.', false);
      } catch (e) {
        showDashStatus(e.message || 'Failed to save supported sites.', true);
      }
    });
  </script>
</body>
</html>
