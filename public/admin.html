<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin | LM3DPTFY Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
</head>

<body class="admin-page">
  <div class="page-shell">
    <!-- Top bar -->
    <header class="topbar">
      <div class="topbar-inner">
        <a class="brand" href="/" title="Home">
          <img src="/lm3dptfy-logo-tp-cropped.png" alt="LM3DPTFY logo" />
          <div class="brand-title">
            <strong>Let Me 3D Print That For You</strong>
            <span>Admin dashboard • Private</span>
          </div>
        </a>

        <div class="nav-right">
          <a class="pill-link" href="/">Home</a>
          <button id="logoutTopBtn" class="pill-link" type="button">Log out</button>
        </div>
      </div>
    </header>

    <main class="page-main">
      <div class="main-inner">

        <!-- Login section -->
        <div id="loginCard" class="card" style="max-width:560px;margin:0 auto;padding:18px;">
          <h1 class="admin-title" style="font-size:1.25rem;margin:0 0 6px;">Admin login</h1>
          <p class="admin-subtitle" style="margin:0 0 14px;">Sign in to see and manage quote requests.</p>

          <form id="loginForm" class="stl-form">
            <div>
              <label for="adminEmail" class="field-label">Admin email</label>
              <input type="email" id="adminEmail" class="field-input" required />
            </div>
            <div>
              <label for="adminPassword" class="field-label">Password</label>
              <input type="password" id="adminPassword" class="field-input" required />
            </div>
            <button type="submit" class="btn-primary">Log in</button>
            <p id="loginStatus" class="status-message" style="display:none;"></p>
          </form>
        </div>

        <!-- Dashboard section -->
        <div id="dashboardCard" style="display:none;">
          <div class="admin-head">
            <div>
              <h1 class="admin-title">Quote requests</h1>
              <p class="admin-subtitle">Active + archived requests from lm3dptfy.online.</p>
            </div>

            <div class="admin-actions">
              <button id="reloadSheetsBtn" class="btn-primary btn-sm" type="button">Refresh from Sheets</button>
              <button id="syncSheetsBtn" class="btn-primary btn-sm" type="button">Sync to Sheets</button>
              <a href="/api/export/csv" class="btn-primary btn-sm" style="text-decoration:none;">Export CSV</a>
              <a href="/api/export/json" class="btn-primary btn-sm" style="text-decoration:none;">Export JSON</a>
            </div>
          </div>

          <p id="dashboardStatus" class="status-message" style="display:none;"></p>

          <section class="card table-card">
            <h2 class="section-title" style="margin-top:0;">Active</h2>

            <div class="table-wrapper">
              <table class="request-table">
                <colgroup>
                  <col class="col-created">
                  <col class="col-name">
                  <col class="col-email">
                  <col class="col-stl">
                  <col class="col-notes">
                  <col class="col-adminnotes">
                  <col class="col-status">
                  <col class="col-fulfilled">
                  <col class="col-tracking">
                  <col class="col-reply">
                  <col class="col-archive">
                </colgroup>
                <thead>
                  <tr>
                    <th>Created</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>STL</th>
                    <th>Customer notes</th>
                    <th>Admin notes</th>
                    <th>Status</th>
                    <th>Fulfilled by</th>
                    <th>Tracking #</th>
                    <th>Reply</th>
                    <th>Archive</th>
                  </tr>
                </thead>
                <tbody id="activeBody">
                  <tr>
                    <td colspan="11" style="text-align:center;padding:16px;color:var(--muted);">Loading…</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <p class="tip">Tip: Set status to <strong>Shipped</strong> to enable Tracking #. When you paste tracking, an email draft opens automatically.</p>
          </section>

          <section class="card table-card">
            <h2 class="section-title" style="margin-top:0;">Archived</h2>

            <div class="table-wrapper">
              <table class="request-table">
                <colgroup>
                  <col class="col-created">
                  <col class="col-name">
                  <col class="col-email">
                  <col class="col-stl">
                  <col class="col-notes">
                  <col class="col-adminnotes">
                  <col class="col-status">
                  <col class="col-fulfilled">
                  <col class="col-tracking">
                  <col class="col-reply">
                  <col class="col-archive">
                </colgroup>
                <thead>
                  <tr>
                    <th>Created</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>STL</th>
                    <th>Customer notes</th>
                    <th>Admin notes</th>
                    <th>Status</th>
                    <th>Fulfilled by</th>
                    <th>Tracking #</th>
                    <th>Reply</th>
                    <th>Archive</th>
                  </tr>
                </thead>
                <tbody id="archivedBody">
                  <tr>
                    <td colspan="11" style="text-align:center;padding:16px;color:var(--muted);">No archived requests.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <p class="tip">Tip: Bookmark <strong>/admin</strong>. This page is meant to stay private.</p>
          </section>
        </div>
      </div>
    </main>

    <footer class="site-footer">
      LM3DPTFY Admin · Keep this page private.
    </footer>
  </div>

  <script>
    const loginForm = document.getElementById('loginForm');
    const loginStatus = document.getElementById('loginStatus');
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const activeBody = document.getElementById('activeBody');
    const archivedBody = document.getElementById('archivedBody');
    const dashboardStatus = document.getElementById('dashboardStatus');
    const reloadBtn = document.getElementById('reloadSheetsBtn');
    const syncBtn = document.getElementById('syncSheetsBtn');
    const logoutTopBtn = document.getElementById('logoutTopBtn');

    const STATUS_OPTIONS = [
      { value: 'new', label: 'New' },
      { value: 'responded', label: 'Responded' },
      { value: 'quote_approved', label: 'Quote approved' },
      { value: 'sent_to_printer', label: 'Sent to printer' },
      { value: 'print_complete', label: 'Print complete' },
      { value: 'qc_complete', label: 'QC complete' },
      { value: 'shipped', label: 'Shipped' },
      { value: 'paid', label: 'Paid' },
    ];

    const FULFILLED_BY_OPTIONS = [
      { value: '', label: '-- None --' },
      { value: 'Jared', label: 'Jared' },
      { value: 'Robert', label: 'Robert' },
      { value: 'Terence', label: 'Terence' }
    ];

    const GMAIL_AUTH_USER = 'lm3dptfy@gmail.com';

    function buildGmailUrl(toEmail, subject, body) {
      let url = 'https://mail.google.com/mail/?view=cm&fs=1&tf=1';
      url += '&authuser=' + encodeURIComponent(GMAIL_AUTH_USER);
      url += '&to=' + encodeURIComponent(toEmail);
      url += '&su=' + encodeURIComponent(subject);
      url += '&body=' + encodeURIComponent(body);
      return url;
    }

    function showDashStatus(msg, isError) {
      dashboardStatus.textContent = msg;
      dashboardStatus.style.display = 'block';
      dashboardStatus.classList.toggle('status-error', !!isError);
      dashboardStatus.classList.toggle('status-success', !isError);
      if (!isError) setTimeout(() => { dashboardStatus.style.display = 'none'; }, 4500);
    }

    function renderRow(r) {
      const tr = document.createElement('tr');

      const createdTd = document.createElement('td');
      createdTd.textContent = r.createdAt ? new Date(r.createdAt).toLocaleString() : '';
      tr.appendChild(createdTd);

      const nameTd = document.createElement('td');
      nameTd.textContent = r.name || '';
      tr.appendChild(nameTd);

      const emailTd = document.createElement('td');
      if (r.email) {
        const a = document.createElement('a');
        a.href = 'mailto:' + r.email;
        a.textContent = r.email;
        emailTd.appendChild(a);
      }
      tr.appendChild(emailTd);

      const stlTd = document.createElement('td');
      if (r.stlLink) {
        const a = document.createElement('a');
        a.href = r.stlLink;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'View';
        stlTd.appendChild(a);
      }
      tr.appendChild(stlTd);

      const notesTd = document.createElement('td');
      notesTd.textContent = r.details || '';
      tr.appendChild(notesTd);

      const adminNotesTd = document.createElement('td');
      const adminNotes = document.createElement('textarea');
      adminNotes.className = 'admin-notes-input';
      adminNotes.placeholder = 'What did we email the user?';
      adminNotes.value = r.adminNotes || '';
      adminNotes.dataset.id = r.id;
      adminNotesTd.appendChild(adminNotes);
      tr.appendChild(adminNotesTd);

      const statusTd = document.createElement('td');
      const statusSelect = document.createElement('select');
      statusSelect.className = 'status-select status-select-main';
      statusSelect.dataset.id = r.id;
      STATUS_OPTIONS.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        if ((r.status || 'new') === opt.value) o.selected = true;
        statusSelect.appendChild(o);
      });
      statusTd.appendChild(statusSelect);
      tr.appendChild(statusTd);

      const fulfilledTd = document.createElement('td');
      const fulfilledSelect = document.createElement('select');
      fulfilledSelect.className = 'status-select fulfilled-select';
      fulfilledSelect.dataset.id = r.id;
      FULFILLED_BY_OPTIONS.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        if ((r.fulfilledBy || '') === opt.value) o.selected = true;
        fulfilledSelect.appendChild(o);
      });
      fulfilledTd.appendChild(fulfilledSelect);
      tr.appendChild(fulfilledTd);

      const trackingTd = document.createElement('td');
      const trackingInput = document.createElement('input');
      trackingInput.type = 'text';
      trackingInput.className = 'tracking-input';
      trackingInput.dataset.id = r.id;
      trackingInput.dataset.email = r.email || '';
      trackingInput.dataset.name = r.name || '';
      trackingInput.dataset.stl = r.stlLink || '';
      trackingInput.value = r.trackingNumber || '';

      const isShipped = (r.status || '') === 'shipped';
      trackingInput.disabled = !isShipped;
      trackingInput.placeholder = isShipped ? 'Paste tracking' : 'Set status to Shipped';
      trackingTd.appendChild(trackingInput);
      tr.appendChild(trackingTd);

      const replyTd = document.createElement('td');
      const replyA = document.createElement('a');
      replyA.href = '#';
      replyA.className = 'reply-link';
      replyA.textContent = 'Reply';
      replyA.dataset.email = r.email || '';
      replyA.dataset.name = r.name || '';
      replyA.dataset.stl = r.stlLink || '';
      replyTd.appendChild(replyA);
      tr.appendChild(replyTd);

      const archiveTd = document.createElement('td');
      const archiveCheckbox = document.createElement('input');
      archiveCheckbox.type = 'checkbox';
      archiveCheckbox.dataset.id = r.id;
      archiveCheckbox.checked = !!r.archived;
      archiveTd.appendChild(archiveCheckbox);
      tr.appendChild(archiveTd);

      return tr;
    }

    async function loadRequests() {
      try {
        const res = await fetch('/api/requests', { credentials: 'include' });
        if (res.status === 401) {
          loginCard.style.display = 'block';
          dashboardCard.style.display = 'none';
          return;
        }

        const data = await res.json();
        const active = data.filter(r => !r.archived);
        const archived = data.filter(r => r.archived);

        activeBody.innerHTML = '';
        archivedBody.innerHTML = '';

        if (active.length === 0) {
          activeBody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:16px;color:var(--muted);">No active requests.</td></tr>';
        } else {
          active.forEach(r => activeBody.appendChild(renderRow(r)));
        }

        if (archived.length === 0) {
          archivedBody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:16px;color:var(--muted);">No archived requests.</td></tr>';
        } else {
          archived.forEach(r => archivedBody.appendChild(renderRow(r)));
        }

        loginCard.style.display = 'none';
        dashboardCard.style.display = 'block';
        showDashStatus('Loaded ' + data.length + ' request(s).', false);
      } catch (err) {
        console.error(err);
        showDashStatus('Error loading requests: ' + err.message, true);
      }
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginStatus.style.display = 'block';
      loginStatus.textContent = 'Signing in...';
      loginStatus.classList.remove('status-error', 'status-success');

      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        if (!res.ok) throw new Error('Invalid email or password');

        loginStatus.textContent = 'Login successful. Loading dashboard...';
        loginStatus.classList.add('status-success');

        await loadRequests();
      } catch (err) {
        loginStatus.textContent = err.message;
        loginStatus.classList.add('status-error');
      }
    });

    async function doLogout() {
      try { await fetch('/api/logout', { method: 'POST', credentials: 'include' }); } catch(e){}
      loginCard.style.display = 'block';
      dashboardCard.style.display = 'none';
      loginForm.reset();
    }

    logoutTopBtn.addEventListener('click', doLogout);

    if (reloadBtn) {
      reloadBtn.addEventListener('click', async () => {
        showDashStatus('Refreshing from Google Sheets...', false);
        try {
          const res = await fetch('/api/sheets/reload', { method: 'POST', credentials: 'include' });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || 'Reload failed');
          showDashStatus('Reloaded ' + (data.count || 0) + ' requests from Sheets.', false);
          loadRequests();
        } catch (err) {
          showDashStatus('Reload failed: ' + err.message, true);
        }
      });
    }

    if (syncBtn) {
      syncBtn.addEventListener('click', async () => {
        showDashStatus('Syncing to Google Sheets...', false);
        try {
          const res = await fetch('/api/sheets/sync', { method: 'POST', credentials: 'include' });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || 'Sync failed');
          showDashStatus('Synced ' + (data.count || 0) + ' requests to Sheets.', false);
        } catch (err) {
          showDashStatus('Sync failed: ' + err.message, true);
        }
      });
    }

    function onTableChange(e) {
      const t = e.target;

      // status change
      if (t.classList.contains('status-select-main')) {
        const id = t.dataset.id;
        const status = t.value;
        showDashStatus('Updating status...', false);

        fetch(`/api/requests/${id}/status`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
        })
          .then(res => { if (!res.ok) throw new Error('Failed to update status'); return res.json(); })
          .then(() => loadRequests())
          .catch(err => showDashStatus('Error updating status: ' + err.message, true));
      }

      // fulfilled by change
      if (t.classList.contains('fulfilled-select')) {
        const id = t.dataset.id;
        const fulfilledBy = t.value;
        showDashStatus('Updating fulfilled by...', false);

        fetch(`/api/requests/${id}/fulfilled`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fulfilledBy }),
        })
          .then(res => { if (!res.ok) throw new Error('Failed to update fulfilled by'); return res.json(); })
          .then(() => showDashStatus('Fulfilled by updated.', false))
          .catch(err => showDashStatus('Error updating fulfilled by: ' + err.message, true));
      }

      // archive checkbox
      if (t.type === 'checkbox' && t.dataset.id) {
        const id = t.dataset.id;
        const archived = t.checked;
        showDashStatus(archived ? 'Archiving...' : 'Unarchiving...', false);

        fetch(`/api/requests/${id}/archive`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ archived }),
        })
          .then(res => { if (!res.ok) throw new Error('Failed to update archive'); return res.json(); })
          .then(() => loadRequests())
          .catch(err => showDashStatus('Error updating archive: ' + err.message, true));
      }
    }

    function onTableClick(e) {
      const a = e.target.closest('.reply-link');
      if (!a) return;
      e.preventDefault();

      const email = a.dataset.email;
      if (!email) return;

      const name = a.dataset.name || '';
      const stl = a.dataset.stl || '';
      const subject = 'LM3DPTFY Quote Reply';
      const body =
        'Hi ' + name + ',\n\n' +
        'Thanks for your quote request for:\n' + stl + '\n\n' +
        '— LM3DPTFY';

      window.open(buildGmailUrl(email, subject, body), '_blank');
    }

    function saveAdminNotes(textarea) {
      const id = textarea.dataset.id;
      const adminNotes = textarea.value || '';
      fetch(`/api/requests/${id}/admin-notes`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adminNotes }),
      }).catch(() => {});
    }

    function saveTracking(input) {
      const id = input.dataset.id;
      const trackingNumber = input.value || '';
      fetch(`/api/requests/${id}/tracking`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ trackingNumber }),
      }).catch(() => {});
    }

    function openTrackingEmail(input) {
      const email = input.dataset.email || '';
      if (!email) return;

      const name = input.dataset.name || '';
      const tracking = input.value || '';
      const stl = input.dataset.stl || '';

      const subject = 'Your LM3DPTFY order has shipped — Tracking #' + (tracking ? (' ' + tracking) : '');
      const body =
        'Hi ' + name + ',\n\n' +
        'Great news — your print has shipped!\n\n' +
        'Tracking number: ' + tracking + '\n\n' +
        (stl ? ('Your model link: ' + stl + '\n\n') : '') +
        'Thanks again!\n' +
        '— LM3DPTFY';

      window.open(buildGmailUrl(email, subject, body), '_blank');
    }

    function onBlurCapture(e) {
      const t = e.target;
      if (t.classList.contains('admin-notes-input')) saveAdminNotes(t);
      if (t.classList.contains('tracking-input')) saveTracking(t);
    }

    function onPasteCapture(e) {
      const t = e.target;
      if (!t.classList.contains('tracking-input')) return;
      if (t.disabled) return;

      // Let paste land first, then save + open email
      setTimeout(() => {
        saveTracking(t);
        if ((t.value || '').trim()) openTrackingEmail(t);
      }, 10);
    }

    activeBody.addEventListener('change', onTableChange);
    archivedBody.addEventListener('change', onTableChange);
    activeBody.addEventListener('click', onTableClick);
    archivedBody.addEventListener('click', onTableClick);

    // capture blur/paste so it works even when focus changes quickly
    document.addEventListener('focusout', onBlurCapture, true);
    document.addEventListener('paste', onPasteCapture, true);

    loadRequests();
  </script>
</body>
</html>
