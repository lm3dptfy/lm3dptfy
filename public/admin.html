<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin | LM3DPTFY Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="page-shell">
    <main class="page-main">
      <div class="main-inner">
        <!-- Login section -->
        <div id="loginCard">
          <div class="logo-wrap">
            <img
              src="lm3dptfy-logo-tp-cropped.png"
              alt="LM3DPTFY.online - Let Me 3D Print That For You"
              class="main-logo"
            />
          </div>

          <h1 class="request-title">Admin login</h1>
          <p class="request-subtitle">Sign in to see and manage quote requests.</p>

          <form id="loginForm" class="stl-form">
            <div class="field-group">
              <label for="adminEmail" class="field-label">Admin email</label>
              <input type="email" id="adminEmail" class="field-input" required />
            </div>
            <div class="field-group">
              <label for="adminPassword" class="field-label">Password</label>
              <input type="password" id="adminPassword" class="field-input" required />
            </div>
            <button type="submit" class="btn-primary" style="width:100%;">Log in</button>
            <p id="loginStatus" class="status-message" style="display:none;"></p>
          </form>
        </div>

        <!-- Dashboard section -->
        <div id="dashboardCard" class="admin-main-inner" style="display:none;">
          <div class="logo-wrap" style="margin-bottom:24px;">
            <a href="/" class="logo-link">
              <img
                src="lm3dptfy-logo-tp-cropped.png"
                alt="LM3DPTFY.online - Let Me 3D Print That For You"
                class="main-logo"
              />
            </a>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <div>
              <h1 class="admin-header-text">Quote requests</h1>
              <p class="admin-subtitle">Active and archived requests from lm3dptfy.online.</p>
            </div>
            <div style="display:flex; gap:12px; align-items:center;">
              <button id="exportSheetsBtn" class="btn-primary" style="padding:6px 12px; font-size:0.8rem;">Export to Sheets</button>
              <a href="/api/export/csv" class="btn-primary" style="padding:6px 12px; font-size:0.8rem; text-decoration:none; display:inline-block;">Export CSV</a>
              <a href="/api/export/json" class="btn-primary" style="padding:6px 12px; font-size:0.8rem; text-decoration:none; display:inline-block;">Export JSON</a>
              <button id="logoutBtn" class="link-btn logout-btn">Log out</button>
            </div>
          </div>

          <div class="table-wrapper">
            <h2 class="info-title">Active</h2>
            <table class="request-table">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>STL link</th>
                  <th>Notes</th>
                  <th>Status</th>
                  <th>Reply</th>
                  <th>Archive</th>
                </tr>
              </thead>
              <tbody id="activeBody"></tbody>
            </table>
          </div>

          <div class="table-wrapper" style="margin-top:16px;">
            <h2 class="info-title">Archived</h2>
            <table class="request-table">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>STL link</th>
                  <th>Notes</th>
                  <th>Status</th>
                  <th>Reply</th>
                  <th>Archive</th>
                </tr>
              </thead>
              <tbody id="archivedBody"></tbody>
            </table>
          </div>

          <p id="dashboardStatus" class="status-message" style="display:none;"></p>
        </div>
      </div>
    </main>

    <footer class="site-footer">
      LM3DPTFY Admin · Keep this page private.
    </footer>
  </div>

  <script>
    const loginForm = document.getElementById('loginForm');
    const loginStatus = document.getElementById('loginStatus');
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const activeBody = document.getElementById('activeBody');
    const archivedBody = document.getElementById('archivedBody');
    const dashboardStatus = document.getElementById('dashboardStatus');
    const logoutBtn = document.getElementById('logoutBtn');

    const STATUS_OPTIONS = [
      { value: 'new', label: 'New' },
      { value: 'responded', label: 'Responded' },
      { value: 'quote_approved', label: 'Quote approved' },
      { value: 'sent_to_printer', label: 'Sent to printer' },
      { value: 'print_complete', label: 'Print complete' },
      { value: 'qc_complete', label: 'QC complete' },
      { value: 'shipped', label: 'Shipped' },
      { value: 'paid', label: 'Paid' },
    ];

    const GMAIL_AUTH_USER = 'lm3dptfy@gmail.com';

    function buildGmailUrl(toEmail, subject, bodyLines) {
      let url = 'https://mail.google.com/mail/?view=cm&fs=1&tf=1';
      url += '&authuser=' + encodeURIComponent(GMAIL_AUTH_USER);
      url += '&to=' + encodeURIComponent(toEmail);
      url += '&su=' + encodeURIComponent(subject);
      url += '&body=' + encodeURIComponent(bodyLines.join('\\n'));
      return url;
    }

    function safeText(text) {
      return (text || '').replace(/&/g, '&amp;').replace(/</g, '&lt;');
    }

    function buildRow(r) {
      const tr = document.createElement('tr');
      const safeDetails = safeText(r.details || '');

      tr.innerHTML = `
        <td>${new Date(r.createdAt).toLocaleString()}</td>
        <td>${safeText(r.name || '')}</td>
        <td><a href="mailto:${safeText(r.email)}">${safeText(r.email)}</a></td>
        <td><a href="${safeText(r.stlLink)}" target="_blank">View STL</a></td>
        <td>${safeDetails}</td>
        <td class="status-cell"></td>
        <td>
          <button
            class="link-btn reply-gmail-btn"
            data-id="${r.id}"
            data-email="${safeText(r.email)}"
            data-name="${safeText(r.name || '')}"
            data-link="${safeText(r.stlLink)}"
          >
            Reply
          </button>
        </td>
        <td>
          <input
            type="checkbox"
            class="archive-checkbox"
            data-id="${r.id}"
            ${r.archived ? 'checked' : ''}
          />
        </td>
      `;

      const statusCell = tr.querySelector('.status-cell');
      const select = document.createElement('select');
      select.className = 'status-select';
      select.dataset.id = r.id;
      STATUS_OPTIONS.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        if ((r.status || 'new') === opt.value) {
          option.selected = true;
        }
        select.appendChild(option);
      });
      statusCell.appendChild(select);

      return tr;
    }

    async function loadRequests() {
      dashboardStatus.textContent = 'Loading requests...';
      dashboardStatus.style.display = 'block';
      dashboardStatus.classList.remove('status-error', 'status-success');
      
      try {
        const res = await fetch('/api/requests', {
          credentials: 'include',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (res.status === 401) {
          loginCard.style.display = 'block';
          dashboardCard.style.display = 'none';
          dashboardStatus.textContent = '';
          dashboardStatus.style.display = 'none';
          return;
        }
        
        const data = await res.json();

        const active = data.filter(r => !r.archived);
        const archived = data.filter(r => r.archived);

        activeBody.innerHTML = '';
        archivedBody.innerHTML = '';

        if (active.length === 0) {
          activeBody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">No active requests.</td></tr>';
        } else {
          active.forEach(r => {
            activeBody.appendChild(buildRow(r));
          });
        }

        if (archived.length === 0) {
          archivedBody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">No archived requests.</td></tr>';
        } else {
          archived.forEach(r => {
            archivedBody.appendChild(buildRow(r));
          });
        }

        dashboardStatus.textContent = '';
        dashboardStatus.style.display = 'none';
      } catch (err) {
        dashboardStatus.textContent = 'Error loading requests: ' + err.message;
        dashboardStatus.classList.add('status-error');
      }
    }

    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      loginStatus.textContent = 'Logging in...';
      loginStatus.style.display = 'block';
      loginStatus.classList.remove('status-error', 'status-success');
      
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Login failed');
        }

        loginStatus.textContent = 'Login successful!';
        loginStatus.classList.add('status-success');
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        loginCard.style.display = 'none';
        dashboardCard.style.display = 'block';
        loginStatus.textContent = '';
        loginStatus.style.display = 'none';
        
        await loadRequests();
        
      } catch (err) {
        loginStatus.textContent = 'Login failed: ' + err.message;
        loginStatus.classList.add('status-error');
      }
    });

    logoutBtn.addEventListener('click', async function() {
      try {
        await fetch('/api/logout', { 
          method: 'POST',
          credentials: 'include'
        });
        loginCard.style.display = 'block';
        dashboardCard.style.display = 'none';
        loginForm.reset();
      } catch (err) {
        console.error('Logout error:', err);
      }
    });

    // Backup to Google Drive
    document.getElementById('backupBtn').addEventListener('click', async function() {
      const btn = this;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Backing up...';
      
      try {
        const res = await fetch('/api/backup/drive', {
          method: 'POST',
          credentials: 'include'
        });
        
        const data = await res.json();
        
        if (res.ok) {
          dashboardStatus.textContent = `✓ Backed up to Google Drive: ${data.file.name}`;
          dashboardStatus.classList.add('status-success');
          dashboardStatus.style.display = 'block';
          setTimeout(() => {
            dashboardStatus.style.display = 'none';
          }, 3000);
        } else {
          throw new Error(data.error || 'Backup failed');
        }
      } catch (err) {
        dashboardStatus.textContent = `✗ Backup error: ${err.message}`;
        dashboardStatus.classList.add('status-error');
        dashboardStatus.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    function handleStatusChange(e) {
      const select = e.target.closest('.status-select');
      if (!select) return;
      const id = select.dataset.id;
      const status = select.value;

      dashboardStatus.textContent = 'Updating status...';
      dashboardStatus.style.display = 'block';
      dashboardStatus.classList.remove('status-success', 'status-error');

      fetch(`/api/requests/${id}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status })
      })
        .then(res => res.json().then(data => ({ res, data })))
        .then(({ res, data }) => {
          if (!res.ok || !data.ok) {
            throw new Error(data.error || 'fail');
          }
          dashboardStatus.textContent = 'Status updated.';
          dashboardStatus.classList.add('status-success');
          setTimeout(() => {
            dashboardStatus.style.display = 'none';
          }, 2000);
        })
        .catch((err) => {
          dashboardStatus.textContent = 'Error: ' + err.message;
          dashboardStatus.classList.add('status-error');
        });
    }

    function handleArchiveToggle(e) {
      const checkbox = e.target.closest('.archive-checkbox');
      if (!checkbox) return;
      const id = checkbox.dataset.id;
      const archived = checkbox.checked;

      fetch(`/api/requests/${id}/archive`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ archived })
      })
        .then(res => res.json().then(data => ({ res, data })))
        .then(({ res, data }) => {
          if (!res.ok || !data.ok) throw new Error(data.error || 'fail');
          loadRequests();
        })
        .catch((err) => {
          dashboardStatus.textContent = 'Error: ' + err.message;
          dashboardStatus.classList.add('status-error');
        });
    }

    function handleReplyClick(e) {
      const btn = e.target.closest('.reply-gmail-btn');
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      const email = btn.getAttribute('data-email');
      const name = btn.getAttribute('data-name') || '';
      const link = btn.getAttribute('data-link') || '';

      const subject = '3D printing quote from LM3DPTFY';
      const bodyLines = [
        name ? `Hi ${name},` : 'Hi,',
        '',
        'Here is your 3D printing quote:',
        '',
        link ? `STLFlix link: ${link}` : '',
        '',
        'Reply here with any questions or to approve the quote.',
        '',
        'Thank you,',
        'LM3DPTFY'
      ].filter(Boolean);

      const gmailUrl = buildGmailUrl(email, subject, bodyLines);
      window.open(gmailUrl, '_blank');

      fetch(`/api/requests/${id}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status: 'responded' })
      })
        .then(() => loadRequests())
        .catch((err) => console.error('Error:', err));
    }

    activeBody.addEventListener('change', handleStatusChange);
    archivedBody.addEventListener('change', handleStatusChange);
    activeBody.addEventListener('change', handleArchiveToggle);
    archivedBody.addEventListener('change', handleArchiveToggle);
    activeBody.addEventListener('click', handleReplyClick);
    archivedBody.addEventListener('click', handleReplyClick);

    loadRequests();
  </script>
</body>
</html>
